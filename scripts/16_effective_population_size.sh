# Todo this use ne_estimator or similar.
## couldn't find any good R packages so this seems like most logical way to proceed

# 1.  Preprocessing
# - need the plink files into genepop format
# - can this be done in plink?
#   - no, can use PGDSpider to go from ped - genpop
#     http://www.cmpg.unibe.ch/software/PGDSpider/#Input_and_output_formats

#CLI on slurm for PGD spider
#need to upload the ped/map files, and all of the spid files
#spid files can make locally, then put

# 2. convert the plink files to genepop, need a folder with all of them 
#  - each of the populations, each of the three clusters
# source files found in:  
#       /raw/LD_files/             - for the populations
#       /raw/HW_files/per_location - for each of the sample locations
# Use the "new" versions relative to the v3 genome for both
# looks like family labels persist, so I'm going to try with just the cluster
# files and see if I can use these to get the location level ne estimats, 
# if not going to have to double back and convert all the populations separately
cd /scratch/nugentc/data/PGDSpider_2.1.1.5/

java -Xmx4096m -Xms512M -jar PGDSpider2-cli.jar -inputfile data/clusters/new_Newfoundland_220k_filtered.ped -inputformat PED  -outputfile data/clusters/new_Newfoundland_220k_filtered_genpop.txt -outputformat GENEPOP -spid data/clusters/nfl_log.spid

java -Xmx4096m -Xms512M -jar PGDSpider2-cli.jar -inputfile data/clusters/new_STLawrence_220k_filtered.ped -inputformat PED  -outputfile data/clusters/new_STLawrence_220k_filtered_genpop.txt -outputformat GENEPOP -spid data/clusters/stl_log.spid

java -Xmx4096m -Xms512M -jar PGDSpider2-cli.jar -inputfile data/clusters/new_Labrador_220k_filtered.ped -inputformat PED  -outputfile data/clusters/new_Labrador_220k_filtered_genpop.txt -outputformat GENEPOP -spid data/clusters/lab_log.spid

java -Xmx6096m -Xms512M -jar PGDSpider2-cli.jar -inputfile data/clusters/new_wildNA_220k_filtered.ped -inputformat PED  -outputfile data/clusters/new_wildNA_220k_filtered_genpop.txt -outputformat GENEPOP -spid data/clusters/full_log.spid


# 3. turn NE estimator on (located on desktop)
# from powershell run:
# java -jar .\NeEstimator2x1.jar


# 4. For each sample location and population, run the Ne estimation

# params - estimated using temporal method and heterozygote excess with the default paramaters for the two methods.

#v1
#running for each of the three input files, it appears to be saving the info per population.
# outputs to data/raw/ne_work/clusters/pop_files/ (same as inputs)


#v2
# second set of runs - each cluster turned into a single population, can get 3 population size estimates for use in the demographic history stuff

# - getting OOM for the bigger two populations, may need to move this onto slurm and run via a CLI input there as I did with pgd spider
#overcome with downsample to common size:
python subset_ne_files.py
# - seems the LD and the heterozygote excess methods are giving infinite pop size estimates, while the 
#   Coancestry coefficients is running at a glacial pace (~12 loci in a half hour.)

#trying to limit the LD to every 50th loci, n = ~6k so as to overcome the OOM error.
# still getting error so trying 600 loci to see if I can just get a valid output


# - need to explore the best modification, random downsample of the alleles, or should I instead modify the params for the other two methods and go with those?



# 5. load the results (into R? will need to look at them)
#    - process to a final table with columnns GROUP NE

