library(tidyverse)
library(psych)    # Used to investigate correlations among predictors
library(vegan)    # Used to run RDA
library(ggman)

random5k_subset = read_tsv("interim/RDA_input_uncor_env_and_5k_random_subset_Genetics.tsv")
random5k_subset = random5k_subset[random5k_subset$FID != "Mul",]

names(random5k_subset)

print("low missing data numbers")
sapply(random5k_subset, function(x) sum(is.na(x)))
print("fill with zeros")
random5k_subset[is.na(random5k_subset)] = 0

id_cols = names(random5k_subset)[1:2]
env_cols = names(random5k_subset)[3:8]
gen_cols = names(random5k_subset)[9:length(names(random5k_subset))]


print("Run the RDA")

# take the associated data and make the x and y matricies
y = random5k_subset[gen_cols]
X = random5k_subset[env_cols]

# run the RDA
random5k_rda_out = rda(y~., data = X, scale=T) #thats a terrible function call


## Save an object to a file
# save.image(file = "rda_5k_data.rds")
## Restore the object
# load(file = "rda_5k_data.rds")

print("analyze the RDA outputs")

RsquareAdj(random5k_rda_out)
# $r.squared
# [1] 0.03612687
# 
# $adj.r.squared
# [1] 0.03456931

summary(eigenvals(random5k_rda_out, model = "constrained"))
# Importance of components:
#   RDA1    RDA2     RDA3    RDA4    RDA5    RDA6
# Eigenvalue            102.8805 44.3274 12.09909 8.78355 6.29945 6.24441
# Proportion Explained    0.5696  0.2454  0.06698 0.04863 0.03487 0.03457
# Cumulative Proportion   0.5696  0.8149  0.88193 0.93056 0.96543 1.00000
screeplot(random5k_rda_out) 
print("first two axes explain most of the variation")

print("add the meta data columns for plotting by colour")
NA_PC_Meta = read_tsv("full_wild_PCA_and_meta.tsv")
#add province data to the original meta data file, for consistency
prov_dict = distinct(NA_PC_Meta[c("Province", "SiteCode")])
prov_ids = prov_dict$Province
names(prov_ids) = prov_dict$SiteCode

meta_data = read_tsv('raw/Salmo_220K_Merged2022_ENVmatchyear_Metadata.txt')      
meta_data$province = unlist(lapply(meta_data$SiteCode, function(x){prov_ids[[x]]}))

print("join the metadata to the correct order of the fish in the RDA")
NA_PC_Meta$IID = NA_PC_Meta$fish_id
sub_meta_for_match = left_join(data.frame(IID = random5k_subset$IID), NA_PC_Meta)

unique(sub_meta_for_match$Province)
sub_meta_for_match[is.na(sub_meta_for_match$Province),]

summary(random5k_rda_out)
plot(random5k_rda_out, scaling=3) 

prov = sub_meta_for_match$Province

print("make the provincial colours for plot")
province_vals = c("NL-Labrador", "QC", "NB", "PEI", "NS", "NL", "NA') 
prov_colours = c("#0063a3",   "#fbad26", "#252a2e", "#b44e2a", "#349c44", "#c678dd", "#FFFFFF")
names(prov_colours) = province_vals

plot(random5k_rda_out, type="n", scaling=3)
points(random5k_rda_out, display="species", pch=20, cex=0.7, col="gray32", scaling=3)  #snps
points(random5k_rda_out, display="sites", pch=21, cex=1.3, col="gray32", scaling=3, bg=prov_colours[prov]) #individuals coloured by cluster
text(random5k_rda_out, scaling=3, display="bp", col="#0868ac", cex=1)               # the env
legend("bottomright", legend=names(province_vals), bty="n", col="gray32", pch=21, cex=1, pt.bg=prov_colours)





print("extract the RDA1 loadings and do a manhattan plot")

sum_dat = summary(random5k_rda_out) 
loadings = as_tibble(data.frame(loadings = sum_dat$species))
loadings$marker = rownames(sum_dat$species)
print("then get the map file loaded in to subset the positions")

map_file = "Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.map"
map_df = read_tsv(map_file, skip = 0, col_names = c("chromosome", "marker" , "genetic_distance", "physical_distance"))

loadings_man_df = inner_join()


plot = ggman(loadings_man_df, snp = "marker", bp = "genetic_distance", chrom = "chromosome", pvalue = "loadings", logTransform = TRUE)+
  scale_color_manual(values = colour_combos[[comp]])+
  labs(title =  "RDA1 loadings for the 5k random SNP subset RDA")+
  xlab("Chromosome") +
  ylab("Fst value")+
  theme_minimal()


ggsave(paste0('external/RDA1_loadings_5ksubset.png'), plot,  width = 8, height = 3)

