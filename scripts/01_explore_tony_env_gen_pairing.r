setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/data/")

library('tidyverse')


meta_data = read_tsv('raw/Salmo_220K_Merged2022_ENVmatchyear_Metadata.txt')      

is_na(meta_data)

names(meta_data)
dim(meta_data)

table(meta_data$SiteCode)
length(table(meta_data$SiteCode)) #149 locations in the environmental data

no_na_meta = na.omit(meta_data)

# this may be a little too stringent, change it to check if there are NAs in only the env data columns (missing info elsewhere doesn't matter)

leading_cols = c("SiteCode", "ID")
pred_cols = c("Minimum.Air.Temperature", "Air.Temperature",         "Maximum.Air.Temperature", "Total.Precipitation" ,    "Dew.Point.Temperature",
              "Relative.Humidity",       "Wind.Direction",          "Solar.Radiation",         "Atmospheric.Pressure" ,   "Snow.Precipitation",
              "Snow.Depth.Accumulation", "Snow.Water.Equivalent",   "Wind.Speed.at.2.meters")

keep_cols = c(leading_cols, pred_cols)

relevant_meta_cols = meta_data[keep_cols]
no_na_meta = na.omit(relevant_meta_cols)


length(table(no_na_meta$SiteCode)) #94 locations

# make ped and map file in case there are needed
#plink --bfile Salmo_220K_Merged2022_COMPLETE_ENVmatchyear --recode --tab --out Salmo_220K_Merged2022_COMPLETE_ENVmatchyear --chr-set 30 no-xy




print("first two columns of the full geno file - for EDA")
geno_just_individual_ids = read_tsv('raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.NOSEX', col_names = c("FID", "IID"))      


table(geno_just_individual_ids$FID)
length(table(geno_just_individual_ids$FID)) #94 locations in the genetic data
      
print("There are 94 locations in the genotype data post filtering, there were 149 in the metadata")
print("there were only 94 locations in the metadata that had no NAs in the dataframe (matching sets)")


# read in the raw file and have a look at what is in that
# appears to be dosage encoded genotypes with the main PED leading columns
geno_data = read_table('raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.raw')      

dim(geno_data) #3865 individuals
names(geno_data)[1:10] #leading ped cols, then dosage GTs
geno_data[1:5, 1:10] #dosage encoded
geno_data$FID[1:10] #family IDs
geno_data$IID[1:10] #individual IDs - this is what the data should be joined to the meta data with


print("could collapse the genotype data down to a per site basis")
print("if doing this, would need to ensure minimum per site sample sizes")


print("check the matching of the geno and meta ids")

length(geno_data$IID) #3865
length(meta_data$ID) #5570
matches = sum(geno_data$IID %in% meta_data$ID)
matches == length(geno_data$IID)
#all geno_individuals have matching metadata
no_na_matches = sum(geno_just_individual_ids$IID %in% no_na_meta$ID)
no_na_matches == length(geno_just_individual_ids$IID)
no_na_matches #3865 rows with no NAs in the environmental data


# are the extra geno data from unique locations (should they be included in any PCA?)
# no - loooks like all those in the geno file are the matches to the complete metadata rows


print("make an intermediate version of the metadata file - subset so it is an exact match to the geno data")

output_meta_data = meta_data[meta_data$ID %in% no_na_meta$ID,]
output_meta_data = output_meta_data[output_meta_data$ID %in% geno_just_individual_ids$IID,]
nrow(output_meta_data) == 3865
write_tsv(output_meta_data, "interim/salmo_220K_wildNA_ENVmatchyear_full_Metadata.tsv")

print("Also make a version with just the environmental columns and the ID columns (For RDA and such)")

relevant_meta_cols = output_meta_data[keep_cols]
write_tsv(relevant_meta_cols, "interim/salmo_220K_wildNA_ENVmatchyear_ENV_variable_columns.tsv")





