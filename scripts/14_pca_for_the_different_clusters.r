############
# load libraries

library(tidyverse)
library(ggman)
theme_set(theme_bw())
library(pcadapt)
library(data.table)



############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)



############
print("generate the lists of individuals for creating the subsets for the PCAs")
print("have the full sets, remaking with just the high Q individuals to see if admixture affects the clustering")

full_per_individ_q_vals = read_tsv("interim/cluster_and_q_data_combined.tsv")

keep =  c("SiteCode", "fish_id", "location_id", "location_name", "Province" , "lat" , "lon" , "date_of_genotyping",
          "IID",  "CID", "cluster_name",  "Q1", "Q2", "Q3", "home_Q", "total_admixed_Q")  
sub_meta = full_per_individ_q_vals[keep]

per_individ_q_vals = full_per_individ_q_vals[full_per_individ_q_vals$home_Q >= 0.8,]


cluster_names = c("Labrador", "Newfoundland", "St. Lawrence")

#c = "Labrador"
for(c in cluster_names){
  
  sub_df = per_individ_q_vals[per_individ_q_vals$cluster_name == c,]
  
  out_df = sub_df[c("SiteCode", "fish_id")]
  
  names(out_df) = c("FID", "IID")
  
  
  write_tsv(out_df, paste0("raw/", c, "_highQ_individual_list.tsv"))  
}


#347 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep Labrador_highQ_individual_list.tsv --out high_Q_Labrador_220k_filtered

#2153 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep Newfoundland_highQ_individual_list.tsv  --out high_Q_Newfoundland_220k_filtered

#1361 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep STLawrence_highQ_individual_list.tsv  --out high_Q_STLawrence_220k_filtered


list_of_high_q_bed_files = c('raw/high_Q_Labrador_220k_filtered.bed', 'raw/high_Q_Newfoundland_220k_filtered.bed', 'raw/high_Q_STLawrence_220k_filtered.bed')
names(list_of_high_q_bed_files) = c("LAB", "NFL", "STL")

list_of_high_q_fam_files = c('raw/high_Q_Labrador_220k_filtered.fam', 'raw/high_Q_Newfoundland_220k_filtered.fam', 'raw/high_Q_STLawrence_220k_filtered.fam')
names(list_of_high_q_fam_files) = c("LAB", "NFL", "STL")

list_of_full_bed_files = c('raw/LD_files/Labrador_220k_filtered.bed' , 'raw/LD_files/Newfoundland_220k_filtered.bed', 'raw/LD_files/STLawrence_220k_filtered.bed')
names(list_of_full_bed_files) = c("LAB", "NFL", "STL")

list_of_full_fam_files = c('raw/LD_files/Labrador_220k_filtered.fam' , 'raw/LD_files/Newfoundland_220k_filtered.fam', 'raw/LD_files/STLawrence_220k_filtered.fam')
names(list_of_full_fam_files) = c("LAB", "NFL", "STL")

#c = "LAB"
for(c in names(list_of_full_bed_files)){
  print(paste0("on cluster: ", c))
  high_q_bed = list_of_high_q_bed_files[[c]]
  full_bed = list_of_full_bed_files[[c]]

  high_q_fam = list_of_high_q_fam_files[[c]]
  full_fam = list_of_full_fam_files[[c]]
  
  high_cluster_pca = read.pcadapt(high_q_bed, type = "bed")
  high_cluster_PCA_out = pcadapt(high_cluster_pca, K = 2, min.maf = 0.01)
  print("high Q only axis values:")
  print((high_cluster_PCA_out$singular.values)^2*100)   
  
  highQ_cluster_pca_Scores = data.frame(high_cluster_PCA_out$scores)
  colnames(highQ_cluster_pca_Scores) = c("PC1", "PC2")
  highQ_fam_df <- fread(high_q_fam) %>% select(V1, V2)
  colnames(highQ_fam_df) <- c("SiteCode", "fish_id")
  highQ_PCs_with_ids = cbind(highQ_fam_df, highQ_cluster_pca_Scores) 
  
  out_high_Q = left_join(highQ_PCs_with_ids, sub_meta)
  write_tsv(out_high_Q, paste0("interim/", c,"_high_Q_PCA_and_meta.tsv"))
  
    
  full_cluster_pca = read.pcadapt(full_bed, type = "bed")
  full_cluster_pca_out = pcadapt(full_cluster_pca, K = 2, min.maf = 0.01)
  print("full cluster axis values:")
  print((full_cluster_pca_out$singular.values)^2*100) 
  
  
  #add the graphing and output generation in here.
  
  full_cluster_pca_Scores = data.frame(full_cluster_pca_out$scores)
  colnames(full_cluster_pca_Scores) = c("PC1", "PC2")
  full_fam_df <- fread(full_fam) %>% select(V1, V2)
  colnames(full_fam_df) <- c("SiteCode", "fish_id")
  full_PCs_with_ids = cbind(full_fam_df, full_cluster_pca_Scores) 
  
  out_full = left_join(full_PCs_with_ids, sub_meta)
  write_tsv(out_high_Q, paste0("interim/", c,"_full_indiv_PCA_and_meta.tsv"))
  
}
# 
# [1] "on cluster: LAB"
# [1] "high Q only axis values:"
# [1] 3.104323 2.389208
# Joining, by = c("SiteCode", "fish_id")
# [1] "full cluster axis values:"                                                                                                                  
# [1] 2.811970 2.020818
# Joining, by = c("SiteCode", "fish_id")
# [1] "on cluster: NFL"                                                                                                                            
# [1] "high Q only axis values:"
# [1] 1.457462 1.197040
# Joining, by = c("SiteCode", "fish_id")
# [1] "full cluster axis values:"                                                                                                                  
# [1] 1.312261 1.092917
# Joining, by = c("SiteCode", "fish_id")
# [1] "on cluster: STL"                                                                                                                            
# [1] "high Q only axis values:"
# [1] 2.220433 1.847572
# Joining, by = c("SiteCode", "fish_id")
# [1] "full cluster axis values:"                                                                                                                  
# [1] 2.003713 1.601749
# Joining, by = c("SiteCode", "fish_id")


print("read in the cluster pca results, generate the PCA plots and viz with different colourings")

highQ_pca_out_file_list = c("interim/LAB_high_Q_PCA_and_meta.tsv", "interim/NFL_high_Q_PCA_and_meta.tsv", "interim/STL_high_Q_PCA_and_meta.tsv")
full_pca_out_file_list = c("interim/LAB_full_indiv_PCA_and_meta.tsv", "interim/NFL_full_indiv_PCA_and_meta.tsv", "interim/STL_full_indiv_PCA_and_meta.tsv")


print("turn the numbers above into axis labels and apply them to the plots as you go.")







