############
# load libraries

library(tidyverse)
library(ggman)
theme_set(theme_bw())
library(pcadapt)


############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)



############
print("generate the lists of individuals for creating the subsets for the PCAs")

per_individ_q_vals = read_tsv("interim/cluster_and_q_data_combined.tsv")


per_individ_q_vals = per_individ_q_vals[per_individ_q_vals$home_Q >= 0.8,]


cluster_names = c("Labrador", "Newfoundland", "St. Lawrence")

#c = "Labrador"
for(c in cluster_names){
  
  sub_df = per_individ_q_vals[per_individ_q_vals$cluster_name == c,]
  
  out_df = sub_df[c("SiteCode", "fish_id")]
  
  names(out_df) = c("FID", "IID")
  
  
  write_tsv(out_df, paste0("raw/", c, "_highQ_individual_list.tsv"))  
}


#347 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep Labrador_highQ_individual_list.tsv --out high_Q_Labrador_220k_filtered

#2153 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep Newfoundland_highQ_individual_list.tsv  --out high_Q_Newfoundland_220k_filtered

#1361 samples:
#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --maf 0.01 --make-bed --keep STLawrence_highQ_individual_list.tsv  --out high_Q_STLawrence_220k_filtered


list_of_high_q_bed_files = c('raw/high_Q_Labrador_220k_filtered.bed', 'raw/high_Q_Newfoundland_220k_filtered.bed', 'raw/high_Q_STLawrence_220k_filtered.bed')
names(list_of_high_q_bed_files) = c("LAB", "NFL", "STL")
list_of_full_bed_files = c('raw/LD_files/Labrador_220k_filtered.bed' , 'raw/LD_files/Newfoundland_220k_filtered.bed', 'raw/LD_files/STLawrence_220k_filtered.bed')
names(list_of_full_bed_files) = c("LAB", "NFL", "STL")

#c = "LAB"
for(c in names(list_of_full_bed_files)){
  high_q_bed = list_of_high_q_bed_files[[c]]
  full_bed = list_of_full_bed_files[[c]]
  
  high_cluster_pca = read.pcadapt(high_q_bed, type = "bed")
  high_cluster_PCA_out = pcadapt(high_cluster_pca, K = 3, min.maf = 0.01)
  (high_cluster_PCA_out$singular.values)^2*100 # 3.481847 1.704028 ; these are the PC axes scores
  
  full_cluster_pca = read.pcadapt(full_bed, type = "bed")
  wild_salmon_PCA = pcadapt(wild_salmon, K = 3, min.maf = 0.01)
  (wild_salmon_PCA$singular.values)^2*100 # 3.481847 1.704028 ; these are the PC axes scores
  
  
}

