
#########################
# libraries
library(tidyverse)
#install.packages("ggforce")
library(ggforce)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)


############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)

alter_cluster_name = function(x){
  if(x == "St. Lawrence"){
    return("Maritimes")
  }else{
    return(x)
  }
}

alter_cluster_IDs = function(x){
  if(x == "STL"){
    return("Maritimes")
  }else if (x == "NFL"){
    return("Newfoundland")
  }else if (x == "LAB"){
    return("Labrador")
  }else{
    return(x)
  }
}


############
# load the PCA info, and the EU ancestry estimates from the previous project
colour_coord =        c("#16ABEE",  "#CC9753",   "#3EB489" )
names(colour_coord) = c("Labrador", "Maritimes", "Newfoundland")


#current PCA
clustered_full_data_PCA = read_tsv("interim/full_data_PCA_kmeans_cluster_info.tsv")

#current admix 
clusters_per_location  = read_tsv("interim/cluster_and_q_data_combined.tsv")
clusters_per_location$Population = unlist(lapply(clusters_per_location$river_majority_cluster, alter_cluster_IDs))
clusters_per_location$location_id = clusters_per_location$SiteCode
dedup_locations = distinct(clusters_per_location[c("location_id", "lat", "lon")])
dedup_locations = dedup_locations[!duplicated(dedup_locations$location_id),]
dedup_locations

#previous Eu admixture estimates
#made with old admixture script: scripts/all_fish_baseline_220k_admix_pca.r
full_admix = read_tsv("C:/Users/camnu/bin/salmon-euro-introgression/data/May2022_SNPchip_220K/SNPchip_100MS_SNPpanel_King7_Compare/SNPchip_220K/all_data_admix_vals.tsv")
full_admix$Eu_proportion  = full_admix$Q2


full_data = left_join(clustered_full_data_PCA, full_admix[c("fish_id", "Eu_proportion")])
hist(full_data$Eu_proportion)
max(full_data$Eu_proportion) #highest Eu admixture proportion is 6%

sum(full_data$Eu_proportion <= 0.01)




#####
# join per indiviudal, do a series of correlations with the admixture levels
Q_to_name = function(Q){  
  col_dict = c("LAB", "NFL", "MAR")  
  names(col_dict)  =  c("Q3", "Q2", "Q1")
  return(col_dict[[Q]])
}

full_admix = inner_join(full_admix[c("fish_id", "Eu_proportion")] , clusters_per_location)

  
mar_corr = cor.test(full_admix$Q1, full_admix$Eu_proportion,  method = "pearson", use = "complete.obs")
summary(mar_corr)
mar_corr #-.61 correlation


nfl_corr = cor.test(full_admix$Q2, full_admix$Eu_proportion,  method = "pearson", use = "complete.obs")
summary(nfl_corr)
nfl_corr #.38 correlation


lab_corr = cor.test(full_admix$Q3, full_admix$Eu_proportion,  method = "pearson", use = "complete.obs")
summary(lab_corr)
lab_corr #.37

#lab_corr = lm(Q3~Eu_proportion, full_admix)
#summary(lab_corr)
#lab_corr #.37


mar_cor_plot = ggplot(full_admix, aes(x=Eu_proportion, y=Q1)) +
                    geom_point(colour = "#CC9753") +
                    xlab("European Admxiture Proportion")+
                    ylab("Maritime Population Admixture Proportion")+
                    xlim(0.0, 0.06)+
                    ylim(0.0, 1.0)+ 
                    theme_classic()

nfl_cor_plot = ggplot(full_admix, aes(x=Eu_proportion, y=Q2)) +
                    geom_point(colour =  "#3EB489") +
                    xlab("European Admxiture Proportion")+
                    ylab("Newfoundland Population Admixture Proportion")+
                    xlim(0.0, 0.06)+
                    ylim(0.0, 1.0)+ 
                    theme_classic()

lab_cor_plot = ggplot(full_admix, aes(x=Eu_proportion, y=Q3)) +
                    geom_point(colour = "#16ABEE") +
                    xlab("European Admxiture Proportion")+
                    ylab("Labrador Population Admixture Proportion")+
                    xlim(0.0, 0.06)+
                    ylim(0.0, 1.0)+ 
                    theme_classic()

#slight but significant correlations between the groups
# specifically, the LAB population seems to be derived of individuals with 2-4% EU ancestry, suggesting that this population
# may be a signal of European influence


full_admix %>%
  group_by(river_majority_cluster) %>%
  summarize(mean_eu = mean(Eu_proportion),
            count = n())

# river_majority_cluster mean_eu count
# LAB                    0.0264    433
# NFL                    0.0174   3255
# STL                    0.00635  1763



######
# join and plot per location

per_location_mean_eu = full_data %>%
                          group_by(location_id) %>%
                            summarize(mean_eu = mean(Eu_proportion), 
                                      count = n())
  


per_location_eu_positions = left_join(dedup_locations, per_location_mean_eu)


plot_Eu_admix = function(df, colour_coord){
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  EuAdmix_plot = ggplot(data = world) +
    geom_sf(fill = "antiquewhite1")+
    coord_sf(xlim = c(long_min - 2.5, long_max + 2.5), 
             ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=mean_eu), 
                position=position_jitter(width = .12, height = 0.12))+
    xlab("Longitude") + ylab("Latitude") +
    labs(colour = "Mean Q-Eu")
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_rect(fill = "#E7F2F8",
                                          colour = "#E7F2F8",
                                          size = 0.5, linetype = "solid"))
  
  
  return(EuAdmix_plot)
}


fig_admix_Eu = plot_Eu_admix(per_location_eu_positions, colour_coord)





####
#combine into a four panel plot


library(patchwork)


print("patchwork version")
mar_cor_plot = mar_cor_plot + labs(tag = "A")
nfl_cor_plot = nfl_cor_plot + labs(tag = "B")
lab_cor_plot = lab_cor_plot + labs(tag = "C")
fig_admix_Eu = fig_admix_Eu + labs(tag = "D")

outplot = ( mar_cor_plot | nfl_cor_plot) / 
          ( lab_cor_plot | fig_admix_Eu) 


ggsave('external/panelled_figure_Eu.tiff', outplot, width = 12, height = 12)
ggsave('external/panelled_figure_Eu.jpeg', outplot, width = 12, height = 12)




##############
### Methods
# 
# - We looked for evidence of European secondary contact across the sampled range and aimed to quantify the effects of any observed contact on the population structure.
# - The per individual admixture proportions for the k=3 populations were compared to per individual estimates of European admixture proportions, obtained from Nugent et al. 2023)
# - look for correlation of lineages with European ancestry, which would implicate European secondary contact as factor contributing to the observed genetic differences/
# - The mean per location and per lineage Eu admixture proportions were also calculated.


##############
# prelim results
#- see plot, relates to conclusions below
#summary stats:

#admix is possion distribution of 0-6%
#max is 5.9%

#per group
# river_majority_cluster mean_eu count
# LAB                    0.0264    433
# NFL                    0.0174   3255
# STL                    0.00635  1763


#correlations of admix proportions and levels
# all significant, the Lab most interesting, definitely not linear
# mar_corr #-.61 correlation
# nfl_corr #.38 correlation
# lab_corr #.37




############
# Follow up and TODO
############


# Conclusions / remarks to note and next steps
# 
# We can see that there is:
#   
#   1. very low admixture in the maritimes population
#   2. low levels of European admixture in the newfoundland population, primarily clustered to the southeast of the sampling range.
#   3. individuals primarily assigned to the LAB population seem (dots falling above 0.5 on the y axis of Panel C) seem to have consistent low levels of European ancestry (2-4% Eu admixture proportions).
#   4. Essentially no evidence of European admixture within the MAR lineage.
# 
# So based on this I conclude:
#   - the influences of European secondary contact are limted to the eastern edge of the North American population.
#   - A potential explination for the Labrador population is a lineage of historical secondary contact between NFL individuals moving north and European individuals
# 
# From Ian and Tony:
#   - seems like a gap in EU admixture between SE NF and Labrador  (e.g. different admixture events)
#   - definite pattern of elevated EU variation in LAB, but it's also high across coastal locations in NL
#   - we have always wondered if the EU in Labrador was from a previous period of secondary contact and the NF is just the most recent
#     -  me: I think we can add to this discussion, if not make a definitive statement of the previous contact there. 
# 
# 
# The LAB has evidence of low consistent Eu admixture in the 2-4% range. Of the two sourthern groups, it is most similar to the NFL line. Therefore it may be the product of historic admixture of the NFL and European lineages in this region, or conversely (and less likely) it may be a separate glacial lineage that experienced European secondary contact at some point
#   - if we are to conclude different contact events between the NFL (SE) and the LAB (North) then we need to quantify that they're low european levels but different parts of the genome
# 
# 
# # To quantify this last bit we need to:
# 1. genomic locations of EU introgression for each lineage (LAB/NFL, the western lineage not relevant)
# 2. remove sites across the genome with EU introgression and see if the differences between NF and Lab are diminished 
#     - pull this from the admixture paper, remove sites with significant P values associating them with the PCA.




#Primary follow up Q to quantify:
# Can we see evidence of different secondary contacts between Europe and the LAB and NFL lineages, or does all the observed admixture
# appear to originate from a common source

#TODO - see script 24 for more details
#1. Get list of SNPs contributing to EU admixture separation (from previous paper? P values of PCAdapt run)

