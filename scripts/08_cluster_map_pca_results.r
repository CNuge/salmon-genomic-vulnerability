#########################
# libraries

library(tidyverse)
#install.packages("ggforce")
library(ggforce)
library(ggplot2)
theme_set(theme_bw())

library(rnaturalearth)
library(rnaturalearthdata)

#########################
# functions

get_wss = function(input_df, PC_colnames = c("PC1", "PC2"), max_k = 10){
  
  pc_only = input_df[PC_colnames]
  
  within_sum_squares = c()
  print("determine optimal k")
  for (i in 1:max_k){
    within_sum_squares[i] = sum(kmeans(pc_only,
                                       centers=i, nstart=25, iter.max=1000)$withinss)
  }
  
  return(within_sum_squares)
}


assign_kmeans = function(input_df, PC_colnames = c("PC1", "PC2"), k = 3){
  
  pc_only = input_df[PC_colnames]
  
  optimal_k = kmeans(pc_only, k, nstart=25, iter.max=1000)
  
  input_df$cluster = as.factor(optimal_k$cluster)
  
  return(input_df)
}


#df = clustered_full_data_PCA
plot_kmeans = function(df, main_title = "", 
                       subtitle = ""){
  
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  clusters_by_study_range = ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(long_min - 2, long_max + 2), 
             ylim = c(lat_min - 2, lat_max + 2), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=as.factor(Cluster)), 
                position=position_jitter(width = .25, height = 0.25), alpha = 0.5)+
    labs(title = main_title, 
         subtitle = subtitle, 
         color = "Cluster")
  
  return(clusters_by_study_range)
}


#########################
# load the data
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)


#5455 individuals, all including those not matched to the environment data
full_data_PCA = read_tsv("full_wild_PCA_and_meta.tsv")
full_data_PCA$IID = full_data_PCA$fish_id


#reduced individuals, only those with good matches to the metadata
# matched_data_PCA = read_tsv("interim/220k_wild_meta_match_genetic_PCs_with_ids.tsv")
# matched_metadata = read_tsv("interim/salmo_220K_wildNA_ENVmatchyear_full_Metadata.tsv")
# matched_metadata$IID = matched_metadata$ID
# matched_data_PCA_with_meta = left_join(matched_data_PCA, matched_metadata )
# matched_data_PCA_with_meta_and_prov = left_join(matched_data_PCA_with_meta, full_data_PCA[c("IID", "Province")])
# write_tsv(matched_data_PCA_with_meta_and_prov, "interim/220k_wild_meta_match_genetic_PCs_with_ids_and_metadata.tsv")

matched_data_PCA_with_meta_and_prov = read_tsv("interim/220k_wild_meta_match_genetic_PCs_with_ids_and_metadata.tsv")



#########################
# get wss and plot

print("get wss for k of 1 - 10")
full_wss = get_wss(full_data_PCA)

matched_wss = get_wss(matched_data_PCA_with_meta_and_prov)


print("plot the skree info")

print("full data set")
plot(1:10, full_wss, type="b", xlab="Number of Clusters",
     ylab="Within groups sum of squares", main = "Determining optimal k-means clustering of full individual PCA data")



print("matched data set")
plot(1:10, matched_wss, type="b", xlab="Number of Clusters",
     ylab="Within groups sum of squares", main = "Determining optimal k-means clustering of matched individual PCA data")

print("three appears optimal for both")


##########################
# assign individuals to clusters via k means clustering


clustered_full_data_PCA = assign_kmeans(full_data_PCA)

clustered_matched_data_PCA = assign_kmeans(matched_data_PCA_with_meta_and_prov)


###########################
# rename clusters, save the clusters to file

#full:   1 = Labrador  2 = St. Lawrence  3 = Newfoundland 
#matched: 1 = Newfoundland 2 = Labrador 3 = St. Lawrence

full_cluster_names = c("Labrador", "St. Lawrence", "Newfoundland")
matched_cluster_names = c("Newfoundland", "Labrador", "St. Lawrence")

clustered_full_data_PCA$Cluster = unlist(lapply(clustered_full_data_PCA$cluster, function(x) full_cluster_names[[x]]))
clustered_matched_data_PCA$Cluster = unlist(lapply(clustered_matched_data_PCA$cluster, function(x) matched_cluster_names[[x]]))


write_tsv(clustered_full_data_PCA, "interim/full_data_PCA_kmeans_cluster_info.tsv")
write_tsv(clustered_matched_data_PCA, "interim/matched_data_PCA_kmeans_cluster_info.tsv")


clustered_full_data_PCA = read_tsv("interim/full_data_PCA_kmeans_cluster_info.tsv")


table(clustered_full_data_PCA$location_id, clustered_full_data_PCA$cluster_name )


###########################
# plot the clusters

full_pcs_clusters = ggplot() + geom_point(data = clustered_full_data_PCA, aes(x = PC1, y = PC2, colour=Cluster))+
  geom_mark_ellipse(data=clustered_full_data_PCA, aes(x = PC1, y = PC2, fill = Cluster,
                                       label = Cluster),
                    expand = unit(0.5,"mm"))+
  labs(title =  "Atlantic salmon samples, k-means clustering of PCs, 3 groups is optimal", 
       subtitle = "5455 individuals, PCA based on 65576 SNPs (post filtering)")+
  xlab("PC1, 3.39% variance explained") +
  ylab("PC2, 1.46% variance explained")

ggsave('external/full_individual_set_kmeans_PCA.png', full_pcs_clusters)


matched_pcs_clusters = ggplot() + geom_point(data = clustered_matched_data_PCA, aes(x = PC1, y = PC2, colour=Cluster))+
  geom_mark_ellipse(data=clustered_matched_data_PCA, aes(x = PC1, y = PC2, fill = Cluster,
                                                      label = Cluster),
                    expand = unit(0.5,"mm"))+
  labs(title =  "Atlantic salmon samples, k-means clustering of PCs, 3 groups is optimal", 
       subtitle = "3865 individuals, PCA based on 65576 SNPs (post filtering)")+
  xlab("PC1, 3.48% variance explained") +
  ylab("PC2, 1.70% variance explained")

ggsave('external/matched_individual_set_kmeans_PCA.png', matched_pcs_clusters)




###########################
# plot the assignments on a map


full_kmeans_map = plot_kmeans(clustered_full_data_PCA, 
                              main_title = "Full individuals cluster assignments by location", 
                              subtitle = "")
ggsave('external/full_individual_set_kmeans_map.png', full_kmeans_map)

clustered_matched_data_PCA$lat = clustered_matched_data_PCA$Lat
clustered_matched_data_PCA$lon = clustered_matched_data_PCA$Lon

matched_kmeans_map = plot_kmeans(clustered_matched_data_PCA, 
                                 main_title = "Matched individuals cluster assignments by location", 
                                 subtitle = "")
ggsave('external/matched_individual_set_kmeans_map.png', matched_kmeans_map)




#################################################################################
#################################################################################
#################################################################################
# figure refinement for paper
#################################################################################
#################################################################################
#################################################################################

publication_plot_kmeans = function(df , colour_coord){
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  clusters_by_study_range = ggplot(data = world) +
    geom_sf(fill = "antiquewhite1")+
    coord_sf(xlim = c(long_min - 2.5, long_max + 2.5), 
             ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=as.factor(Population)), 
                position=position_jitter(width = .25, height = 0.25), alpha = 0.5)+
    xlab("Longitude") + ylab("Latitude") +
    theme(legend.position="none",
          #panel.grid.major = element_blank(), 
          #panel.grid.minor = element_blank(), 
          panel.background = element_rect(fill = "#E7F2F8",
                                          colour = "#E7F2F8",
                                          size = 0.5, linetype = "solid"))+
    scale_color_manual(values = colour_coord)
  
  
  return(clusters_by_study_range)
}



print("Colour scheme and apply to all plots of the clusters")
# salmon a cute touch, but it gets washed out a bit
#colour_coord =        c("#3D5B59",  "#FCB5AC",   "#3EB489" )
#TOo light
#colour_coord =        c("#74BDCB",  "#FFA384",   "#EFE7BC" )

colour_coord =        c("#16ABEE",  "#CC9753",   "#3EB489" )
names(colour_coord) = c("Labrador", "Maritimes", "Newfoundland")


alter_cluster_name = function(x){
  if(x == "St. Lawrence"){
    return("Maritimes")
  }else{
    return(x)
  }
}

clustered_full_data_PCA$Population = unlist(lapply(clustered_full_data_PCA$Cluster, alter_cluster_name))

Fig1A = publication_plot_kmeans(clustered_full_data_PCA, colour_coord)

ggsave('external/Fig1A.tif', matched_kmeans_map)
ggsave('external/Fig1A.jpeg', matched_kmeans_map)


print("TODO - map with fancier background and no gridlines")
print("PCA with no gridlines, change name to MAR, classification from cluster -> population")


clustered_full_data_PCA

print("final version of figures")


#devtools::install_github("MikkoVihtakari/ggOceanMapsData") 
library(ggOceanMapsData)
library(ggOceanMaps)
library(readxl)
library(tidyverse)
library(ggspatial)


bathy_publication_plot_kmeans = function(df , colour_coord){
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  
  bath_variant = ggOceanMaps::basemap(limits = c(long_min - 2.5,long_max + 2.5, lat_min - 1, lat_max + 1 ), bathymetry = TRUE)
  
  
  clusters_by_study_range = ggplot(data = world) +
    geom_sf(fill = "antiquewhite1")+
    coord_sf(xlim = c(long_min - 2.5, long_max + 2.5), 
             ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=as.factor(Population)), 
                position=position_jitter(width = .25, height = 0.25), alpha = 0.5)+
    xlab("Longitude") + ylab("Latitude") +
    theme(legend.position="none",
          #panel.grid.major = element_blank(), 
          #panel.grid.minor = element_blank(), 
          panel.background = element_rect(fill = "#E7F2F8",
                                          colour = "#E7F2F8",
                                          size = 0.5, linetype = "solid"))+
    scale_color_manual(values = colour_coord)
  
  
  return(clusters_by_study_range)
}
