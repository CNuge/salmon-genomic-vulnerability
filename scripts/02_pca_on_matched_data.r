##install.packages('pcadapt')
library(pcadapt)
library(tidyverse)

setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/data/")


# run the PCA on the filtered SNP file
wild_salmon = read.pcadapt("raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.bed", type = "bed")
wild_salmon_PCA = pcadapt(wild_salmon, K = 2, min.maf = 0.01)
(wild_salmon_PCA$singular.values)^2*100 # 3.481847 1.704028 ; these are the PC axes scores

#make a data frame
wild_salmon_PCA_Scores = data.frame(wild_salmon_PCA$scores)
colnames(wild_salmon_PCA_Scores) = c("PC1", "PC2")


print("first two columns of the full geno file - for EDA")
geno_just_individual_ids = read_tsv('raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.NOSEX', col_names = c("FID", "IID"))      


PCs_with_ids = cbind(geno_just_individual_ids, wild_salmon_PCA_Scores) 

dim(PCs_with_ids)


write_tsv(PCs_with_ids, "interim/220k_wild_meta_match_genetic_PCs_with_ids.tsv")

#Figure2B
pca_of_filtered_wild = ggplot() + 
  geom_point(data = PCs_with_ids, aes(x =PC1, y = PC2))  +
  labs(title = "PCA of filtered genetic variation baseline with all individuals that have full metadata",
        subtitle = "looks the same as the original PCA explore")+
  xlab("PC1 (3.48% of variance explained)") +
  ylab("PC2 (1.70% of variance explained)") +
  theme_classic()

ggsave('interim/reduced_meta_match_pca_plot.png', pca_of_filtered_wild)






print("load in the environmental data and do a PCA of the predictors - by location and by individual")

ENV_predictor_data = read_tsv("interim/salmo_220K_wildNA_ENVmatchyear_ENV_variable_columns.tsv")
pred_cols = c("Minimum.Air.Temperature", "Air.Temperature",         "Maximum.Air.Temperature", "Total.Precipitation" ,    "Dew.Point.Temperature",
              "Relative.Humidity",       "Wind.Direction",          "Solar.Radiation",         "Atmospheric.Pressure" ,   "Snow.Precipitation",
              "Snow.Depth.Accumulation", "Snow.Water.Equivalent",   "Wind.Speed.at.2.meters")


full_metadata = read_tsv("interim/salmo_220K_wildNA_ENVmatchyear_full_Metadata.tsv")



