library(tidyverse)
library(data.table)
library(FactoMineR)
library(factoextra)

##install.packages('pcadapt')
library(pcadapt)


setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/data/")


# run the PCA on the filtered SNP file
wild_salmon = read.pcadapt("raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.bed", type = "bed")
wild_salmon_PCA = pcadapt(wild_salmon, K = 2, min.maf = 0.01)
(wild_salmon_PCA$singular.values)^2*100 # 3.481847 1.704028 ; these are the PC axes scores

#make a data frame
wild_salmon_PCA_Scores = data.frame(wild_salmon_PCA$scores)
colnames(wild_salmon_PCA_Scores) = c("PC1", "PC2")


print("first two columns of the full geno file - for EDA")
geno_just_individual_ids = read_tsv('raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.NOSEX', col_names = c("FID", "IID"))      


PCs_with_ids = cbind(geno_just_individual_ids, wild_salmon_PCA_Scores) 

dim(PCs_with_ids)


write_tsv(PCs_with_ids, "interim/220k_wild_meta_match_genetic_PCs_with_ids.tsv")

#Figure2B
pca_of_filtered_wild = ggplot() + 
  geom_point(data = PCs_with_ids, aes(x =PC1, y = PC2))  +
  labs(title = "PCA of filtered genetic variation baseline with all individuals that have full metadata",
        subtitle = "looks the same as the original PCA explore")+
  xlab("PC1 (3.48% of variance explained)") +
  ylab("PC2 (1.70% of variance explained)") +
  theme_classic()

ggsave('interim/reduced_meta_match_pca_plot.png', pca_of_filtered_wild)




print("load in the environmental data and do a PCA of the predictors - by location and by individual")

ENV_predictor_data = read_tsv("interim/salmo_220K_wildNA_ENVmatchyear_ENV_variable_columns.tsv")
pred_cols = c("Minimum.Air.Temperature", "Air.Temperature",         "Maximum.Air.Temperature", "Total.Precipitation" ,    "Dew.Point.Temperature",
              "Relative.Humidity",       "Wind.Direction",          "Solar.Radiation",         "Atmospheric.Pressure" ,   "Snow.Precipitation",
              "Snow.Depth.Accumulation", "Snow.Water.Equivalent",   "Wind.Speed.at.2.meters")


full_metadata = read_tsv("interim/salmo_220K_wildNA_ENVmatchyear_full_Metadata.tsv")


drop = c("ID")
per_location_ENV_predictor_data = ENV_predictor_data[, !(names(ENV_predictor_data) %in% drop)]
print("keeping one row per location - data are duplicated per individual and 100% matches")
per_location_ENV_predictor_data = unique(per_location_ENV_predictor_data)

ENV_pred_PCA =  PCA(per_location_ENV_predictor_data[pred_cols], scale.unit = TRUE, graph = FALSE)
print(ENV_pred_PCA)
get_eigenvalue(ENV_pred_PCA)
# # 
# eigenvalue variance.percent cumulative.variance.percent
# Dim.1  5.170444e+00     3.977264e+01                    39.77264
# Dim.2  3.061637e+00     2.355106e+01                    63.32370
# Dim.3  1.824039e+00     1.403107e+01                    77.35476
# Dim.4  1.000000e+00     7.692308e+00                    85.04707
# Dim.5  9.494608e-01     7.303545e+00                    92.35062
# Dim.6  3.873207e-01     2.979390e+00                    95.33001
# Dim.7  2.894466e-01     2.226513e+00                    97.55652
# Dim.8  2.224676e-01     1.711289e+00                    99.26781
# Dim.9  5.560851e-02     4.277577e-01                    99.69557
# Dim.10 2.885569e-02     2.219668e-01                    99.91753
# Dim.11 8.992987e-03     6.917682e-02                    99.98671
# Dim.12 1.727385e-03     1.328757e-02                   100.00000
# Dim.13 4.704383e-07     3.618756e-06                   100.00000
get_pca_ind(ENV_pred_PCA)$coord

env_pca_out = dimdesc(ENV_pred_PCA, axes = c(1,2), proba = 0.01)
env_pca_out

env_pred_pca_df = as_tibble(get_pca_ind(ENV_pred_PCA)$coord)


names(env_pred_pca_df) = sapply(seq(1, length(env_pred_pca_df)), function(x){paste0("PC", x)})
env_pred_pca_df$SiteCode = per_location_ENV_predictor_data$SiteCode


pca_of_filtered_env = ggplot() + 
  # geom_point(data = env_pred_pca_df, aes(x = PC1, y = PC2))  +
  labs(title = "PCA of Environmental data",
       subtitle = "Large outlier is: COR (Corneillem, QC; lat: 50.3 lon: -62.9)")+
  xlab("PC1 (39.8% of variance explained)") +
  ylab("PC2 (23.6% of variance explained)") +
  theme_classic()

ggsave('interim/pca_plot_env_predictors_by_location.png', pca_of_filtered_env)


####
# Read in the metadata and full PCA file
####
print("look at the PCA of all individuals (paired to metadata) for the info on location")
NA_PC_Meta = read_tsv("full_wild_PCA_and_meta.tsv")
NA_PC_Meta

NA_PC_Meta[NA_PC_Meta$SiteCode == "COR", ]
print("outlier location is: Corneillem, QC; lat: 50.3 lon: -62.9")
print("cause is two input variables being large outliers (order of magnitude larger than other locations)")
print("snowdepth accumulation: 147.6005479")
print("Snow water equivalent 700.0827397")



print("write to a file")
write_tsv(env_pred_pca_df, 'interim/PCA_of_environment_full.tsv')


print("TODO - decide whether to modify the COR QC vals, drop the location pre-PCA (and from the genetics), or proceed as is")


print("repeat the PCA, dropping the outlier location")

per_location_ENV_predictor_data=per_location_ENV_predictor_data[per_location_ENV_predictor_data$SiteCode != "COR",]






ENV_pred_PCA =  PCA(per_location_ENV_predictor_data[pred_cols], scale.unit = TRUE, graph = FALSE)
print(ENV_pred_PCA)
get_eigenvalue(ENV_pred_PCA)
# 
# eigenvalue variance.percent cumulative.variance.percent
# Dim.1  5.968738e+00     4.591337e+01                    45.91337
# Dim.2  2.033240e+00     1.564030e+01                    61.55367
# Dim.3  1.883793e+00     1.449072e+01                    76.04439
# Dim.4  1.000000e+00     7.692308e+00                    83.73670
# Dim.5  9.871109e-01     7.593160e+00                    91.32986
# Dim.6  4.673019e-01     3.594630e+00                    94.92449
# Dim.7  3.005072e-01     2.311594e+00                    97.23608
# Dim.8  2.270538e-01     1.746568e+00                    98.98265
# Dim.9  7.201062e-02     5.539279e-01                    99.53658
# Dim.10 4.826565e-02     3.712742e-01                    99.90785
# Dim.11 8.928248e-03     6.867883e-02                    99.97653
# Dim.12 3.050235e-03     2.346334e-02                   100.00000
# Dim.13 4.806491e-07     3.697301e-06                   100.00000

get_pca_ind(ENV_pred_PCA)$coord

env_pca_out = dimdesc(ENV_pred_PCA, axes = c(1,2), proba = 0.01)
env_pca_out

env_pred_pca_df = as_tibble(get_pca_ind(ENV_pred_PCA)$coord)


names(env_pred_pca_df) = sapply(seq(1, length(env_pred_pca_df)), function(x){paste0("PC", x)})
env_pred_pca_df$SiteCode = per_location_ENV_predictor_data$SiteCode


pca_of_filtered_env = ggplot() + 
  geom_point(data = env_pred_pca_df, aes(x = PC1, y = PC2))  +
  labs(title = "PCA of Environmental data",
       subtitle = "COR outlier removed")+
  xlab("PC1 (45.91% of variance explained)") +
  ylab("PC2 (15.64% of variance explained)") +
  theme_classic()

ggsave('external/pca_plot_env_predictors_by_location_noCOR.png', pca_of_filtered_env)


write_tsv(env_pred_pca_df, 'interim/PCA_of_environment_noCOR.tsv')




print("simple comparison of the ENV and genetic PCs")

PCs_with_ids = read_tsv("interim/220k_wild_meta_match_genetic_PCs_with_ids.tsv")
PCs_with_ids = PCs_with_ids[PCs_with_ids$FID != "COR",]

env_pred_pca_df = read_tsv( 'interim/PCA_of_environment_noCOR.tsv')
names(env_pred_pca_df) = c("env_PC1", "env_PC2", "env_PC3", "env_PC4", "env_PC5", "FID")

NA_PC_Meta = read_tsv("full_wild_PCA_and_meta.tsv")
NA_PC_Meta$FID = NA_PC_Meta$SiteCode
NA_PC_Meta$IID = NA_PC_Meta$fish_id


genetics_and_PCs = left_join(PCs_with_ids, env_pred_pca_df)
meta_genetics_and_PCs = left_join(genetics_and_PCs, 
                                  NA_PC_Meta[c('IID', 'FID', 'location_id', 'location_name', 'Province', 'lat', 'lon')])


linear_pc1_by_env_pc1_individual = lm(PC1 ~ env_PC1, data = meta_genetics_and_PCs)
summary(linear_pc1_by_env_pc1_individual)
# 
# Call:
#   lm(formula = PC1 ~ env_PC1, data = meta_genetics_and_PCs)
# 
# Residuals:
#   Min        1Q    Median        3Q       Max 
# -0.041532 -0.004691  0.006026  0.009691  0.023744 
# 
# Coefficients:
#   Estimate Std. Error t value Pr(>|t|)    
# (Intercept) -0.0021871  0.0002475  -8.838   <2e-16 ***
#   env_PC1      0.0034095  0.0001160  29.397   <2e-16 ***
#   ---
#   Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# 
# Residual standard error: 0.01457 on 3835 degrees of freedom
# Multiple R-squared:  0.1839,	Adjusted R-squared:  0.1837 
# F-statistic: 864.2 on 1 and 3835 DF,  p-value: < 2.2e-16

linear_pc1_by_env_pc2_individual = lm(PC1 ~ env_PC2, data = meta_genetics_and_PCs)
summary(linear_pc1_by_env_pc2_individual) 
#Adjusted R-squared:  0.4287

linear_pc2_by_env_pc1_individual = lm(PC2 ~ env_PC1, data = meta_genetics_and_PCs)
summary(linear_pc2_by_env_pc1_individual)
# Residual standard error: 0.01125 on 3835 degrees of freedom
# Multiple R-squared:  0.5123,	Adjusted R-squared:  0.5122 
# F-statistic:  4029 on 1 and 3835 DF,  p-value: < 2.2e-16

linear_pc2_by_env_pc2_individual = lm(PC2 ~ env_PC2, data = meta_genetics_and_PCs)
summary(linear_pc2_by_env_pc2_individual)
# Residual standard error: 0.01524 on 3835 degrees of freedom
# Multiple R-squared:  0.1058,	Adjusted R-squared:  0.1056 
# F-statistic: 453.9 on 1 and 3835 DF,  p-value: < 2.2e-16


print("PC1 of genetics and PC2 of environment correlate, and the inverse as well")


individual_genetics_by_env1 = ggplot(meta_genetics_and_PCs) +
  geom_point(aes(x = env_PC2, y = PC1, colour = as.factor(Province)),na.rm=TRUE, alpha = 0.5, position = 'jitter')+
  labs(title = "Genetic PC1 by environment PC2",
       subtitle = "R-squared:  0.43")+
  xlab("PC2 of environmental variables (15.64% of variance)") +
  ylab("PC1 of genetic information (3.48% variance explained)")+
  labs(color='Province')+ 
  geom_smooth(aes(x=env_PC2, y = PC1), colour = "black", method = lm)

ggsave('external/geneticPC1_by_envPC2_linear.png', individual_genetics_by_env1)


individual_genetics_by_env2 = ggplot(meta_genetics_and_PCs) +
  geom_point(aes(x = env_PC1, y = PC1, colour = as.factor(Province)), na.rm=TRUE, alpha = 0.5, position = 'jitter')+
  labs(title = "Genetic PC1 by environment PC1",
       subtitle = "R-squared:  0.1837")+
  xlab("PC1 of environmental variables (45.91% of variance)") +
  ylab("PC1 of genetic information (3.48% variance explained)")+
  labs(color='Province')+ 
  geom_smooth(aes(x=env_PC2, y = PC1), colour = "black", method = lm)

ggsave('external/geneticPC1_by_envPC1_linear.png', individual_genetics_by_env2)


individual_genetics_by_env3 = ggplot(meta_genetics_and_PCs) +
  geom_point(aes(x = env_PC1, y = PC2, colour = as.factor(Province)),na.rm=TRUE, alpha = 0.5, position = 'jitter')+
  labs(title = "Genetic PC2 by environment PC1",
       subtitle = "R-squared:  0.5122")+
  xlab("PC1 of environmental variables (45.91% of variance)") +
  ylab("PC2 of genetic information (1.70% variance explained)")+
  labs(color='Province')+ 
  geom_smooth(aes(x=env_PC2, y = PC1), colour = "black", method = lm)

ggsave('external/geneticPC2_by_envPC1_linear.png', individual_genetics_by_env3)


individual_genetics_by_env4 = ggplot(meta_genetics_and_PCs) +
  geom_point(aes(x = env_PC2, y = PC2, colour = as.factor(Province)),na.rm=TRUE, alpha = 0.5, position = 'jitter')+
  labs(title = "Genetic PC2 by environment PC2",
       subtitle = "R-squared:  0.11")+
  xlab("PC2 of environmental variables (15.64% of variance)") +
  ylab("PC2 of genetic information (1.70% variance explained)")+
  labs(color='Province')+ 
  geom_smooth(aes(x=env_PC2, y = PC1), colour = "black", method = lm)

ggsave('external/geneticPC2_by_envPC2_linear.png', individual_genetics_by_env4)
