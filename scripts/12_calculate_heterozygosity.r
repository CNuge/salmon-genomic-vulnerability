############
# load libraries

library(tidyverse)
library(ggman)
theme_set(theme_bw())


############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)


# this will generate the gt counts and HW-test stats for eeach SNP, can then summarize
#plink --file data --hardy

##full#5455 samples
#plink --bfile LD_files/new_wildNA_220k_filtered --chr-set 30 no-xy --hardy --out HW_files/new_full_220k_filtered_HW_out

##435 samples:
#plink --bfile LD_files/new_Labrador_220k_filtered --chr-set 30 no-xy --hardy --out HW_files/new_Labrador_HW_output

##3244 samples:
#plink --bfile LD_files/new_Newfoundland_220k_filtered --chr-set 30 no-xy --hardy --out HW_files/new_Newfoundland_HW_output

##1776 samples:
#plink --bfile LD_files/new_STLawrence_220k_filtered --chr-set 30 no-xy --hardy --out HW_files/new_STLawrence_HW_output



print("remember to check - is there higher heterozygosity in the regions with the high admixture")
print("plot the avg heterozygosity as sorted bars, colour by whether or not they're high admix")
print("if yes, then the coloured bars will cluster to the high end of the sort.")


full_hw = read_table("raw/HW_files/new_full_220k_filtered_HW_out.hwe")
LAB_hw = read_table("raw/HW_files/new_Labrador_HW_output.hwe")
NFL_hw = read_table("raw/HW_files/new_Newfoundland_HW_output.hwe")
STL_hw = read_table("raw/HW_files/new_STLawrence_HW_output.hwe")


full_hw$cluster = "full"
LAB_hw$cluster = "LAB"
NFL_hw$cluster = "NFL"
STL_hw$cluster = "STL"

all_data = do.call(rbind, list(full_hw, LAB_hw, NFL_hw, STL_hw))

het_summary = all_data %>% 
                group_by(cluster) %>%
                  summarize(mean_obvs_het = mean(`O(HET)`), 
                                mean_expe_het = mean(`E(HET)`))            

het_summary

# cluster   mean_obvs_het mean_expe_het
# 1 full            0.184         0.201
# 2 LAB             0.212         0.228
# 3 NFL             0.201         0.213
# 4 STL             0.189         0.202

print("similar heterozygosity among the different populations")



###############################################################################
#
print("NEXT - do the heterozygosity per location")
#extract lists of locations from the 


###########
# get individual lists to subset the plink files


clustered_full_data_PCA = read_tsv("interim/full_data_PCA_kmeans_cluster_info.tsv")
#clustered_matched_data_PCA = read_tsv("interim/matched_data_PCA_kmeans_cluster_info.tsv")

location_ids = unique(clustered_full_data_PCA$location_id)

location_meta_df = data.frame()

#c = "TR"
for(c in location_ids){
  
  sub_df = clustered_full_data_PCA[clustered_full_data_PCA$location_id == c,]
  
  out_df = sub_df[c("SiteCode", "fish_id")]
  
  names(out_df) = c("FID", "IID")
  
  write_tsv(out_df, paste0("raw/HW_files/per_location/", c, "_individual_list.tsv")) 
  
  location_meta_df = rbind(location_meta_df, data.frame("location" = c, "n_individuals" = nrow(out_df)))
}



#here run script 12b to get the hwe outputs

hwe_df = data.frame()

for(c in location_ids){
  
  full_hw = read_table(paste0("raw/HW_files/per_location/", c,"220k_filtered_HW_out.hwe"))
  
  corr = nrow(full_hw)
  
  full_hw$FDR_P = p.adjust(full_hw$P, method= "fdr")
  
  new_row = data.frame("location" = c,
                       "mean_obvs_het" = mean(full_hw[["O(HET)"]], na.rm = TRUE),
                       "mean_expe_het" = mean(full_hw[["E(HET)"]], na.rm = TRUE),
                       "n_loci" = nrow(full_hw),
                       "n_fdr_sig" = sum(full_hw$FDR_P < 0.05)
                       )
  
  hwe_df = rbind(hwe_df, new_row)
  
}


per_location_heterozygosity_info = left_join(location_meta_df, hwe_df )

write_tsv(per_location_heterozygosity_info, "interim/per_location_heterozygosity_summary.tsv") 

