library(tidyverse)
library(data.table)
library(pcadapt)


############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)

#########################
#1. pull just the wildNA and the Eu wild fish (see script 24 and script 9 and build on that)

# script 9 does the whole process
# - use plink to make a new  file with those individuals
# - make a case/control file and then calculate the fst across the groups
# if info not all there, see :https://www.cog-genomics.org/plink/1.9/basic_stats

#the lists of fish from script 24 should get you started.
print("all_data_admix_vals.tsv") #I copied the file to the git repo
print("see google drive for file version to use")
full_admix = read_tsv("C:/Users/camnu/bin/salmon-euro-introgression/data/May2022_SNPchip_220K/SNPchip_100MS_SNPpanel_King7_Compare/SNPchip_220K/all_data_admix_vals.tsv")

#############################
# 2. read in the outputs and analyze
# identify the 20% highest Fst between Europe and NA
# make a list for plink omission

print("get the p values from the marker loadings in the admixture work")
p_values_for_exclude = read_tsv("C:/Users/camnu/bin/salmon-euro-introgression/data/p_values_NaEu_baseline.tsv")


p_values_for_exclude = p_values_for_exclude[order(p_values_for_exclude$p_values_NaEu_PCA),]

snp_p_values_for_exclude = p_values_for_exclude[1:as.integer(nrow(p_values_for_exclude) *.25),]
snp_p_values_for_keep = p_values_for_exclude[as.integer(nrow(p_values_for_exclude) *.25):nrow(p_values_for_exclude),]


nrow(snp_p_values_for_exclude) #dropping the 16k SNPs with most significant p val for NA/Eu separation
nrow(snp_p_values_for_keep)


print("plink exclude SNPs")
write.table(snp_p_values_for_exclude['snp'], "high_eu_p_val_exclude.out", col.names = F, row.names = F, quote = F, sep = "\t")


# plink --bfile raw/wildNA_220k_filtered --exclude high_eu_p_val_exclude.out --out raw/Eutrimmed_wildNA_220k_filtered --make-bed --chr-set 30 no-xy --allow-extra-chr
# plink --bfile raw/Eutrimmed_wildNA_220k_filtered --recode --tab --out raw/Eutrimmed_wildNA_220k_filtered --make-bed --chr-set 30 no-xy --allow-extra-chr



#############################
# 3. omit SNPs from the wildNA with the highest Fst using plink (pull them out of the currently used file
# for the PCA in 08_cluster_map_pca_results.r)

# result: will have a new file, with the wild NA individuals, missing 20% of the SNPs that are the most Eu differentiated


# run the PCA on the filtered SNP file
trimmed_wild_salmon = read.pcadapt("raw/Eutrimmed_wildNA_220k_filtered.bed", type = "bed")
trimmed_wild_salmon_PCA = pcadapt(trimmed_wild_salmon, K = 2, min.maf = 0.01)
(trimmed_wild_salmon_PCA$singular.values)^2*100 #  2.0187308 0.7422481 ; these are the PC axes scores


#make a data frame
trimmed_wild_salmon_PCA_Scores = data.frame(trimmed_wild_salmon_PCA$scores)
colnames(trimmed_wild_salmon_PCA_Scores) = c("PC1", "PC2")

geno_just_individual_ids = read_tsv('raw/Eutrimmed_wildNA_220k_filtered.NOSEX', col_names = c("SiteCode", "fish_id"))      
PCs_with_ids = cbind(geno_just_individual_ids, trimmed_wild_salmon_PCA_Scores) 


alter_cluster_name = function(x){
  if(x == "St. Lawrence"){
    return("Maritimes")
  }else{
    return(x)
  }
}

colour_coord =        c("#16ABEE",  "#CC9753",   "#3EB489" )
names(colour_coord) = c("Labrador", "Maritimes", "Newfoundland")

clustered_full_data_PCA = read_tsv("interim/full_data_PCA_kmeans_cluster_info.tsv")
clustered_full_data_PCA$Population = unlist(lapply(clustered_full_data_PCA$Cluster, alter_cluster_name))


full_PCs_with_ids = inner_join(clustered_full_data_PCA[c("SiteCode", "fish_id", "Province", "Population")], PCs_with_ids[c("fish_id", "PC1", "PC2")]) 


reduced_Eu_Fig1B = ggplot() + geom_point(data = full_PCs_with_ids, aes(x = PC1, y = PC2, colour=Population), alpha = 0.7)+
  geom_mark_ellipse(data=full_PCs_with_ids, aes(x = PC1, y = PC2, colour = Population, label = Population),
                    expand = unit(0.2,"mm"))+
  xlab("PC1, 2.02% variance explained") +
  ylab("PC2, 0.74% variance explained") +
  scale_color_manual(values = colour_coord)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggsave('external/FigureS8.jpeg', reduced_Eu_Fig1B)
ggsave('external/FigureS8.tiff', reduced_Eu_Fig1B)


#############################
# 4. then redo the PCA and make the ouput plot.
# if the LAB are now in the NFL group, can conclude that the european FST SNPs are driving the population strucutre.

