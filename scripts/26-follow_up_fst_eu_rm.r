library(tidyverse)


############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)

#########################
#1. pull just the wildNA and the Eu wild fish (see script 24 and script 9 and build on that)

# script 9 does the whole process
# - use plink to make a new  file with those individuals
# - make a case/control file and then calculate the fst across the groups
# if info not all there, see :https://www.cog-genomics.org/plink/1.9/basic_stats

#the lists of fish from script 24 should get you started.
print("all_data_admix_vals.tsv") #I copied the file to the git repo
print("see google drive for file version to use")
full_admix = read_tsv("C:/Users/camnu/bin/salmon-euro-introgression/data/May2022_SNPchip_220K/SNPchip_100MS_SNPpanel_King7_Compare/SNPchip_220K/all_data_admix_vals.tsv")

#############################
# 2. read in the outputs and analyze
# identify the 20% highest Fst between Europe and NA
# make a list for plink omission

print("get the p values from the marker loadings in the admixture work")
p_values_for_exclude = read_tsv("C:/Users/camnu/bin/salmon-euro-introgression/data/p_values_NaEu_baseline.tsv")


p_values_for_exclude = p_values_for_exclude[order(p_values_for_exclude$p_values_NaEu_PCA),]

snp_p_values_for_exclude = p_values_for_exclude[1:as.integer(nrow(p_values_for_exclude) *.25),]
snp_p_values_for_keep = p_values_for_exclude[as.integer(nrow(p_values_for_exclude) *.25):nrow(p_values_for_exclude),]


nrow(snp_p_values_for_exclude) #dropping the 16k SNPs with most significant p val for NA/Eu separation
nrow(snp_p_values_for_keep)


print("plink exclude SNPs")


# plink --bfile Salmo_220K_Merged2022_COMPLETE_ENVmatchyear --exclude wild_Salmo220K_Polyhigh_nodup_nohyb_maf01_NA_EU_window_LD.prune.out --out Eutrimmed_Salmo_220K_Merged2022_COMPLETE_ENVmatchyear --make-bed --chr-set 30 no-xy --allow-extra-chr



#############################
# 3. omit SNPs from the wildNA with the highest Fst using plink (pull them out of the currently used file
# for the PCA in 08_cluster_map_pca_results.r)

# result: will have a new file, with the wild NA individuals, missing 20% of the SNPs that are the most Eu differentiated


# run the PCA on the filtered SNP file
trimmed_wild_salmon = read.pcadapt("raw/Eutrimmed_Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.bed", type = "bed")
trimmed_wild_salmon = pcadapt(wild_salmon, K = 2, min.maf = 0.01)
(trimmed_wild_salmon$singular.values)^2*100 # 3.481847 1.704028 ; these are the PC axes scores


#############################
# 4. then redo the PCA and make the ouput plot.
# if the LAB are now in the NFL group, can conclude that the european FST SNPs are driving the population strucutre.

