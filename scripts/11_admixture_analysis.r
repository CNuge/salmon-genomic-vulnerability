
############
# load libraries

library(tidyverse)
library(ggman)
theme_set(theme_bw())
library(data.table())

library(rnaturalearth)
library(rnaturalearthdata)

############
# set path
data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)



#############
# conduct the admixture analysis 


##full data set, k == 3 based on the clustering work
# admixture wildNA_220k_filtered.bed 3





##########
# plot the result

Q_file = "raw/wildNA_220k_filtered.3.Q"
fam_file= "raw/wildNA_220k_filtered.fam"

#load in the Q data
AdmixQ_NA_EU = fread(Q_file)
colnames(AdmixQ_NA_EU) = c("Q1", "Q2", "Q3")
dim(AdmixQ_NA_EU) #5455, 

#load in the fam file
FAM_NA_EU = fread(fam_file) %>% select(V1,V2)
colnames(FAM_NA_EU) = c("SiteCode", "fish_id")

full_q_data = cbind(FAM_NA_EU, AdmixQ_NA_EU)

print("swap this file for more up to date one with the clusters and things")
clustered_full_data_PCA = read_tsv("interim/full_data_PCA_kmeans_cluster_info.tsv")
table(clustered_full_data_PCA$Province)
table(clustered_full_data_PCA$Cluster)

################################################################################
print("k=3")
meta_k3_Q_vals = left_join(clustered_full_data_PCA, full_q_data)

meta_k3_Q_vals = meta_k3_Q_vals[!is.na(meta_k3_Q_vals$Province), ]
table(clustered_full_data_PCA$Province)

k3_qlong = gather(meta_k3_Q_vals, Q_type, Q, Q1, Q2, Q3) 
k3_qlong =k3_qlong[order(k3_qlong$data_class, k3_qlong$location_id),]
k3_qlong$data_class = as.factor(k3_qlong$Province)


k3_qlong = k3_qlong[order(k3_qlong$Cluster, k3_qlong$Province, k3_qlong$location_id),]
k3_qlong = k3_qlong[!is.na(k3_qlong$Province), ]
k3_qlong = k3_qlong[!is.na(k3_qlong$Cluster), ]

print("can change order by sitecode to something else, i.e. province")
k3_admix_bar = ggplot(data=k3_qlong, aes(x=reorder(fish_id,  Cluster), y=Q, fill=Q_type))+
  geom_bar(stat = "identity")+
  scale_y_continuous(expand = c(0,0))+
  ylab("Admixture proportion")+
  labs(title="Admixture of NA wild samples", 
       subtitle = "5455 NA fish only, K=3")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text = element_text(colour="black", size=12),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12))


ggsave('external/NA_wild_k3_ADMIX.png', k3_admix_bar)


print("faceted plot")
k3_panel_facet_admix_bar = ggplot(data=k3_qlong, aes(x=reorder(fish_id, Cluster), y=Q, fill=Q_type))+
  geom_bar(stat = "identity")+
  scale_y_continuous(expand = c(0,0))+
  facet_wrap(~Cluster, scales = "free", ncol = 2)+
  ylab("Admixture proportion")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text = element_text(colour="black", size=12),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12))

ggsave(paste0('external/wild_na_faceted_cluster_ADMIX_k3.png'), k3_panel_facet_admix_bar)


k3_panel_facet_admix_bar_province = ggplot(data=k3_qlong, aes(x=reorder(fish_id, Cluster), y=Q, fill=Q_type))+
  geom_bar(stat = "identity")+
  scale_y_continuous(expand = c(0,0))+
  facet_wrap(~Province, scales = "free", ncol = 2)+
  ylab("Admixture proportion")+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text = element_text(colour="black", size=12),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12))

ggsave(paste0('external/wild_na_faceted_province_ADMIX_k3.png'), k3_panel_facet_admix_bar_province)





print("use these data to look at the levels of mixture in the different groups")
meta_k3_Q_vals

#Q1 == STL
#Q2 == NFL
#Q3 == LAB
code_cluster = c("LAB", "NFL", "STL")
names(code_cluster) = c("Labrador","Newfoundland","St. Lawrence")

meta_k3_Q_vals$CID = unlist(lapply(meta_k3_Q_vals$Cluster, function(x)code_cluster[[x]]))

# what are the average levels of mixture

# for those with > 1/3 mixture, are they from certain locations? Is this evidence of admixture of distinct lineages?


# Determine the proportion of genetic variance derived from the home cluster
#df = meta_k3_Q_vals
#
#
cluster_native_proporiton = function(df){
  values = df$CID
  col_dict = c("Q3", "Q2", "Q1")
  
  names(col_dict)  = c("LAB", "NFL", "STL")  
   
  col_select = unlist(lapply(values, function(x){col_dict[[x]]}))
  
  native_q_val = unlist(lapply(1:nrow(df), function(i) df[i,][[col_select[[i]]]]  ))
  
  df$home_Q = native_q_val
  
  return(df)
}


meta_k3_Q_vals = cluster_native_proporiton(meta_k3_Q_vals)

meta_k3_Q_vals$total_admixed_Q = 1 - meta_k3_Q_vals$home_Q

hist(meta_k3_Q_vals$home_Q)

lab_cluster = meta_k3_Q_vals[meta_k3_Q_vals$CID == "LAB",]
nfl_cluster = meta_k3_Q_vals[meta_k3_Q_vals$CID == "NFL",]
stl_cluster = meta_k3_Q_vals[meta_k3_Q_vals$CID == "STL",]
  
hist(lab_cluster$home_Q)
hist(nfl_cluster$home_Q)
hist(stl_cluster$home_Q)

meta_k3_Q_vals$low_home_q = meta_k3_Q_vals$home_Q < 0.66

low_q_table = table(meta_k3_Q_vals$home_Q < 0.66, meta_k3_Q_vals$CID)
low_q_table
#        LAB  NFL  STL
# FALSE  391 2611 1480
# TRUE    40  633  296

prop.table(low_q_table, 2)
# 
#              LAB        NFL        STL
# FALSE 0.90719258 0.80487053 0.83333333
# TRUE  0.09280742 0.19512947 0.16666667

print("10 - 20% individuals with greater than 33% mixed origin genome across the different pops")



low_home_Q_individs = meta_k3_Q_vals[meta_k3_Q_vals$home_Q < 0.66,]
low_home_Q_individs #969 fish with home q less than 66%

mixed_fish_locations = sort(table(low_home_Q_individs$location_name))

table(low_home_Q_individs$Province) #mainly NL but that is selection bias
#seems like clustered around the middle


original_totals = table(meta_k3_Q_vals$location_name)


mixed_fish_original = original_totals[names(mixed_fish_locations)]

mixed_by_location_freqs = mixed_fish_locations / mixed_fish_original

high_mixture_locations = mixed_by_location_freqs[mixed_by_location_freqs>0.5]
length(high_mixture_locations)
#29 locations displaying high admixture levels




meta_k3_Q_vals$is_high_mixture = unlist(lapply(meta_k3_Q_vals$location_name, function(x) x %in% names(high_mixture_locations)))



#df = clustered_full_data_PCA
plot_admix_smmary = function(df, main_title = "", 
                       subtitle = ""){
  
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  clusters_by_study_range = ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(long_min - 2, long_max + 2), 
             ylim = c(lat_min - 2, lat_max + 2), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=as.factor(low_home_q)), 
                position=position_jitter(width = .25, height = 0.25), alpha = 0.5)+
    labs(title = main_title, 
         subtitle = subtitle, 
         color = "Is High Admixture Individual")
  
  return(clusters_by_study_range)
}


admix_key_locations = plot_admix_smmary(meta_k3_Q_vals, 
                                          main_title = "Locations of origin for high admixture individuals", 
                                        subtitle = "High admixture defined as home Q < 0.66; 29 locations with >50% indviduals")




ggsave('external/high_admixture_by_location.png', admix_key_locations)





print("TODO - count and locate the number of locations with individuals from >1 k means cluster")





