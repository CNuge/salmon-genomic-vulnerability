
# See notes on:
# New method to quantify climactic differences
# Go through the plan there, looking at if all the requesite data are available, if
# so then set up a subfolder here and get to work on generating the data and 
# using it to conduct the analyses.

#######
# location
####### 
setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/scripts")

#######
# libraries
####### 

library(tidyverse)

#######
# functions
####### 


#######
# genetic response variable
####### 

print("stand in for the final response variable")
print("would want the per location mean heterozygosity I think")
print("would this be effected by sammple size?")

clustered_full_data_PCA = read_tsv( "../data/interim/full_data_PCA_kmeans_cluster_info.tsv")
climate_vars = c("Minimum.Air.Temperature", "Air.Temperature",        "Maximum.Air.Temperature", "Total.Precipitation",
                 "Dew.Point.Temperature",  "Relative.Humidity",     "Wind.Direction",        "Solar.Radiation",    
                 "Atmospheric.Pressure",  "Snow.Precipitation",      "Snow.Depth.Accumulation", "Snow.Water.Equivalent",
                 "Wind.Speed.at.2.meters") 




#######
# per location trend calculations
####### 

diff_days = function(year, month, day, baseline = "1979-12-31"){
  as.numeric(difftime(paste0(year, "-", month,"-", day), baseline , units = "days"))
}

## This was run, can start with the saved version to save time.
#climate_df = read_csv("../data/raw/ClimateDataSalmon_1980_2022.csv")
#climate_df$time_series_x = unlist(lapply(1:nrow(climate_df), function(i){
#  diff_days(climate_df$Year[[i]], climate_df$Month[[i]], climate_df$Day[[i]])
#}))
#write_csv(climate_df, "../data/raw/MODDED_ClimateDataSalmon_1980_2022.csv")

climate_df = read_csv("../data/raw/MODDED_ClimateDataSalmon_1980_2022.csv")


trend_df = data.frame()

#location = "ENG"
for (location in unique(climate_df$Name)){
  print(paste0("on location: ", location))
  #has the per day info for 1980 - 2022
  sub_df = climate_df[climate_df$Name == location,]
  
  location_trends = data.frame()
  #clim_var = "Air.Temperature"
  for(clim_var in climate_vars){
    print(paste0("on variable: ", clim_var))
    #put the given variable into the formula
    assoc_test = lm(as.formula(paste0(clim_var, "~time_series_x")), sub_df)
    
    intercept = assoc_test$coefficients[[2]]
    slope = assoc_test$coefficients[[2]]
    
    trends = data.frame(clim_var = clim_var, intercept = intercept, slope = slope)
    location_trends = rbind(location_trends, trends)
  }
  location_trends$location = location
  
  trend_df = rbind(trend_df, location_trends)
}

write_tsv(trend_df, "../data/interim/per_location_env_var_slopes.csv")
#trend_df = read_tsv("../data/interim/per_location_env_var_slopes.csv")

trend_df = as_tibble(trend_df)


######
# gather and summarieze the trends
# need to know what axes are associated with which slopes!
######

#can then gather the trends to go from wide data to long.
#then do a dimensionality reduction on how things are changing




##########
# Spot check the data
#########

outliers_a = trend_df[trend_df$slope < -0.02,]
outliers_b = trend_df[trend_df$slope > 0.02,]

sub_trend_df = trend_df[trend_df$slope > -0.1,]
sub_trend_df = sub_trend_df[sub_trend_df$slope < 0.1,]

sub_trend_df = trend_df[trend_df$slope > -0.02,]
sub_trend_df = sub_trend_df[sub_trend_df$slope < 0.02,]


trendline_boxplots =  ggplot(data = sub_trend_df, aes(x = clim_var, y = slope)) + 
  geom_boxplot()+
  labs(title = "variation in environmental variable slopes across locations",
       subtitle = "dropped outliers of >0.02 and < 0.02 (2 points removed)")+
  xlab("climate variable") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("slope of time series trendline")

ggsave("../data/trendline_boxplots.png", trendline_boxplots)




sub_df
clim_var ="Air.Temperature"
time_val = "time_series_x"

plot_time_series = function(df, time_val, clim_var){
out =  ggplot(data = df, aes(x = .data[[time_val]], y = .data[[clim_var]])) + 
  geom_point()+
  geom_smooth(method=lm , color="red", se=TRUE) +
  labs(title = paste0("Time series plot for location: ", location ),
       subtitle = paste0("Response variable: ", clim_var ))+
  xlab("date series from Jan 1 1980") +
  ylab(clim_var) +
  theme_classic()
} 


eng_temp_plot = plot_time_series(sub_df, "time_series_x", "Air.Temperature")

ggsave("../data/example_slope_plot.png", eng_temp_plot)

eng_dir_plot = plot_time_series(sub_df, "time_series_x", "Wind.Direction")

ggsave("../data/example_slope_plot2.png", eng_dir_plot)

#figure out what is in there on a per location basis, then do some time series trendlines if
# there are per time data per location. generalize the functions to get the 
# per location deltas for the fetures.