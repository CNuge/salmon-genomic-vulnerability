
# See notes on:
# New method to quantify climactic differences
# Go through the plan there, looking at if all the requesite data are available, if
# so then set up a subfolder here and get to work on generating the data and 
# using it to conduct the analyses.

#######
# location
####### 
setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/scripts")

#######
# libraries
####### 

library(tidyverse)

########
# Read in the trend data
########

trend_df = read_tsv("../data/interim/per_location_env_var_slopes.csv")


################################################################################
################################################################################
################################################################################
##########
# Spot check and plot the data
#########

print("switched outlier filtering to the scaled data")
#look at the scaled ones and throw the neceeary exclusions in here.
sub_trend_df = trend_df[trend_df$slope > -0.1,]
sub_trend_df = sub_trend_df[sub_trend_df$slope < 0.04,]

print("second outlier removal based on the scaled results")
print("looking at sever outliers, likely not due to real climactic differences")
print("more likely the result of some measurement or acquisition error")
hist(sub_trend_df[sub_trend_df$clim_var == "Atmospheric.Pressure",]$slope)
min(sub_trend_df[sub_trend_df$clim_var == "Atmospheric.Pressure",]$slope)
hist(sub_trend_df[sub_trend_df$clim_var == "Snow.Precipitation",]$slope)
max(sub_trend_df[sub_trend_df$clim_var == "Snow.Precipitation",]$slope)
hist(sub_trend_df[sub_trend_df$clim_var == "Snow.Depth.Accumulation",]$slope)
max(sub_trend_df[sub_trend_df$clim_var == "Snow.Depth.Accumulation",]$slope)
hist(sub_trend_df[sub_trend_df$clim_var == "Minimum.Air.Temperature",]$slope)
max(sub_trend_df[sub_trend_df$clim_var == "Minimum.Air.Temperature",]$slope)


trendline_boxplots =  ggplot(data = sub_trend_df, aes(x = clim_var, y = slope)) + 
  geom_boxplot()+
  labs(title = "variation in environmental variable slopes across locations",
       subtitle = "dropped outliers of >0.02 and < 0.02 (2 points removed)")+
  xlab("climate variable") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("slope of time series trendline")

ggsave("../data/trendline_boxplots.png", trendline_boxplots)



sub_df
clim_var ="Air.Temperature"
time_val = "time_series_x"
location

plot_time_series = function(df, time_val, clim_var){
out =  ggplot(data = df, aes(x = .data[[time_val]], y = .data[[clim_var]])) + 
  geom_point()+
  geom_smooth(method=lm , color="red", se=TRUE) +
  labs(title = paste0("Time series plot for location: ", location ),
       subtitle = paste0("Response variable: ", clim_var ))+
  xlab("date series from Jan 1 1980") +
  ylab(clim_var) +
  theme_classic()
} 


eng_temp_plot = plot_time_series(sub_df, "time_series_x", "Air.Temperature")

ggsave("../data/example_slope_plot.png", eng_temp_plot)

eng_dir_plot = plot_time_series(sub_df, "time_series_x", "Wind.Direction")

ggsave("../data/example_slope_plot2.png", eng_dir_plot)

#figure out what is in there on a per location basis, then do some time series trendlines if
# there are per time data per location. generalize the functions to get the 
# per location deltas for the fetures.


################################################################################
################################################################################
################################################################################
######
# gather and summarieze the trends
# need to know what axes are associated with which slopes!
######

print("TODO - want to switch this to using sub_trend_df")
print("the outliers do seem weird")

#can then gather the trends to go from wide data to long.
#then do a dimensionality reduction on how things are changing
slope_df = sub_trend_df %>%
  select(clim_var, location, slope) %>%
  pivot_wider(names_from = clim_var, values_from = slope)

print("second outlier removal based on the scaled results and backtrack to histograms")

slope_df = slope_df[slope_df$Atmospheric.Pressure > 0.0,]
slope_df = slope_df[slope_df$Snow.Precipitation < 0.00015,]
slope_df = slope_df[slope_df$Snow.Depth.Accumulation < 0.004,]
slope_df = slope_df[slope_df$Minimum.Air.Temperature > -1e-04,]


sub_df = slope_df[names(slope_df) != "location"]

scaled_slope_df = as_tibble(scale(sub_df))
slope_df = cbind(slope_df["location"], scaled_slope_df)

print("drop atmospheric pressue due to zero variance")
slope_df = subset(slope_df, select = -c(Atmospheric.Pressure) )
slope_df = na.omit(slope_df)


long_scaled = slope_df %>%
  pivot_longer(
    cols = names(slope_df)[names(slope_df) != "location"],
    names_to = "clim_var",
    values_to = "slope",
    values_drop_na = TRUE
  )


scaled_trendline_boxplots =  ggplot(data = long_scaled, aes(x = clim_var, y = slope)) + 
  geom_boxplot()+
  labs(title = "variation in environmental variable slopes across locations",
       subtitle = "standard scaling of the slopes per-variable")+
  xlab("climate variable") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("scaled slope of time series trendline")

ggsave("../data/scaled_trendline_boxplots.png", scaled_trendline_boxplots)


################################################################################
#write the cleaned slope df for use in the association analysis
################################################################################

write_tsv(slope_df, "../data/interim/env_slope_data_cleaned.tsv")



