print("this is EDA code, pull from here to do the het by distance and location stuff.")

#pull the map and the Q subsetting from the admixture file

#######
# location
####### 
setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/scripts")

#######
# libraries
####### 

library(tidyverse)
library(FactoMineR)
library(factoextra)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

########################
# functions
########################




#######
# data
####### 

prin("load the heterozygosity information")
het_dat = read_tsv("../data/interim/per_location_heterozygosity_summary.tsv")
#drop low sample size locations
het_dat = het_dat[het_dat$n_individuals > 10,]
table(het_dat$n_individuals)

print("assess varability of heterozygosity per location")
hist(het_dat$n_individuals)
hist(het_dat$mean_obvs_het) #normally distributed
hist(het_dat$mean_expe_het) #normally distributed

print("load the info on locaiton admixture and filter the high admix locations out")

admixture_per_individual = read_tsv("../data/interim/cluster_and_q_data_combined.tsv")

#is_high_mixture indictes the locations with >50% of indiviauls being low home Q
table(admixture_per_individual$is_high_mixture, admixture_per_individual$location_id)

print("limiting analysis to the non admixture locations (where heterozygosity presumably increased)")
non_mixed_locations = admixture_per_individual[admixture_per_individual$is_high_mixture == FALSE,]

lab_cluster = non_mixed_locations[non_mixed_locations$CID == "LAB",]
nfl_cluster = non_mixed_locations[non_mixed_locations$CID == "NFL",]
stl_cluster = non_mixed_locations[non_mixed_locations$CID == "STL",]

hist(lab_cluster$home_Q)
hist(nfl_cluster$home_Q)
hist(stl_cluster$home_Q)











###################





print("plot the PC values on a map")
# #Possibly:
world = ne_countries(scale = "medium", returnclass = "sf")
class(world)
# #plot a sub region
lat_min = min(meta_sub_df$lat, na.rm = TRUE)
lat_max = max(meta_sub_df$lat, na.rm = TRUE)
long_min = min(meta_sub_df$lon, na.rm = TRUE)
long_max = max(meta_sub_df$lon, na.rm = TRUE)
# 
theme_set(theme_bw())

pc1_env_variance_by_study_range = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 2, long_max + 2), 
           ylim = c(lat_min - 2, lat_max + 2), expand = FALSE) +
  labs(title = "Salmon sampling locations", 
       subtitle = "coloured by PC1 of environmental slope")+
  geom_jitter(data = env_pca_df_w_meta, aes(x = lon, y = lat, colour=PC1))

ggsave('../data/external/PC1_environmental_slope_variation.png', pc1_env_variance_by_study_range)

pc2_env_variance_by_study_range = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 2, long_max + 2), 
           ylim = c(lat_min - 2, lat_max + 2), expand = FALSE) +
  labs(title = "Salmon sampling locations", 
       subtitle = "coloured by PC2 of environmental slope")+
  geom_jitter(data = env_pca_df_w_meta, aes(x = lon, y = lat, colour=PC2))

ggsave('../data/external/PC2_environmental_slope_variation.png', pc2_env_variance_by_study_range)

#PC1 big change in placentia bay region, PC2 locations are scattered, with north seeming high


#df = clustered_full_data_PCA
plot_map = function(df, main_title = "", 
                    subtitle = ""){
  
  
  world = ne_countries(scale = "medium", returnclass = "sf")
  class(world)
  #plot a sub region
  lat_min = min(df$lat, na.rm = TRUE)
  lat_max = max(df$lat, na.rm = TRUE)
  long_min = min(df$lon, na.rm = TRUE)
  long_max = max(df$lon, na.rm = TRUE)
  
  clusters_by_study_range = ggplot(data = world) +
    geom_sf() +
    coord_sf(xlim = c(long_min - 2, long_max + 2), 
             ylim = c(lat_min - 2, lat_max + 2), expand = FALSE) +
    geom_jitter(data = df, aes(x = lon, y = lat, 
                               colour=as.factor(Cluster)), 
                position=position_jitter(width = .25, height = 0.25), alpha = 0.5)+
    labs(title = main_title, 
         subtitle = subtitle, 
         color = "Cluster")
  
  return(clusters_by_study_range)
}



