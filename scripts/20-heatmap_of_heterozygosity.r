print("this is EDA code, pull from here to do the het by distance and location stuff.")

#pull the map and the Q subsetting from the admixture file

#######
# location
####### 
setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/scripts")

#######
# libraries
####### 

library(tidyverse)
library(FactoMineR)
library(factoextra)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(colorspace)


########################
# functions
########################




#######
# data
####### 

prin("load the heterozygosity information")
het_dat = read_tsv("../data/interim/per_location_heterozygosity_summary.tsv")
#drop low sample size locations
het_dat = het_dat[het_dat$n_individuals > 10,]
table(het_dat$n_individuals)

print("assess varability of heterozygosity per location")
hist(het_dat$n_individuals)
hist(het_dat$mean_obvs_het) #normally distributed
hist(het_dat$mean_expe_het) #normally distributed

print("load the info on locaiton admixture and filter the high admix locations out")

admixture_per_individual = read_tsv("../data/interim/cluster_and_q_data_combined.tsv")

#is_high_mixture indictes the locations with >50% of indiviauls being low home Q
table(admixture_per_individual$is_high_mixture, admixture_per_individual$location_id)

print("limiting analysis to the non admixture locations (where heterozygosity presumably increased)")
non_mixed_locations = admixture_per_individual[admixture_per_individual$is_high_mixture == FALSE,]

lab_cluster = non_mixed_locations[non_mixed_locations$CID == "LAB",]
nfl_cluster = non_mixed_locations[non_mixed_locations$CID == "NFL",]
stl_cluster = non_mixed_locations[non_mixed_locations$CID == "STL",]

hist(lab_cluster$home_Q)
hist(nfl_cluster$home_Q)
hist(stl_cluster$home_Q)

print("join the two data sets")

non_mixed_locations$location = non_mixed_locations$location_id
het_and_meta_non_admix = inner_join(het_dat, non_mixed_locations)

table(het_and_meta_non_admix$location)

keep = c("location", "lat", "lon", "n_individuals", "mean_obvs_het", "CID")
het_and_meta_non_admix = het_and_meta_non_admix[keep]
het_and_meta_non_admix = het_and_meta_non_admix[!duplicated(het_and_meta_non_admix),]

##########
# plot locations on a map as scatter plot, and three separate scatter plots

print("plot the PC values on a map as points")

world = ne_countries(scale = "medium", returnclass = "sf")
class(world)
# #plot a sub region
lat_min = min(het_and_meta_non_admix$lat, na.rm = TRUE)
lat_max = max(het_and_meta_non_admix$lat, na.rm = TRUE)
long_min = min(het_and_meta_non_admix$lon, na.rm = TRUE)
long_max = max(het_and_meta_non_admix$lon, na.rm = TRUE)
# 
theme_set(theme_bw())



print("all locations all admixture")
admixture_per_individual$location = admixture_per_individual$location_id

het_and_meta_all = inner_join(het_dat, admixture_per_individual)

table(het_and_meta_all$location)

het_and_meta_all = het_and_meta_all[keep]
het_and_meta_all = het_and_meta_all[!duplicated(het_and_meta_all),]

all_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  geom_point(aes(x = lon, y = lat, colour = mean_obvs_het, size = n_individuals), 
             data = het_and_meta_all, alpha = 0.58) +
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  scale_size(range = c(2, 6)) + 
  theme_bw() + 
  theme(legend.position = "bottom")+
  labs(title = "Mean heterozygosity per location, all locations", 
       subtitle = "including high admixture locations", 
       color = "Mean heterozygosity", 
       size = "number of individuals")


ggsave('../data/external/heterozygosity_map_points_all.png', all_het_map)


print("all locations with low admixture")
all_lowadd_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  geom_point(aes(x = lon, y = lat, colour = mean_obvs_het, size = n_individuals), 
             data = het_and_meta_non_admix, alpha = 0.8) +
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  scale_size(range = c(2, 6)) + 
  theme_bw() + 
  theme(legend.position = "bottom")+
  labs(title = "Mean heterozygosity per location, all locations", 
       subtitle = "locations with less than 50% high admixture individuals", 
       color = "Mean heterozygosity", 
       size = "number of individuals")


ggsave('../data/external/heterozygosity_map_points_all_low_admixture.png', all_lowadd_het_map)


print("LAB only")
LAB_cluster = het_and_meta_non_admix[het_and_meta_non_admix$CID == "LAB",]
LAB_cluster = LAB_cluster[LAB_cluster$lat > 50.,]
# #plot a sub region
lat_min = min(LAB_cluster$lat, na.rm = TRUE)
lat_max = max(LAB_cluster$lat, na.rm = TRUE)
long_min = min(LAB_cluster$lon, na.rm = TRUE)
long_max = max(LAB_cluster$lon, na.rm = TRUE)


LAB_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  geom_point(aes(x = lon, y = lat, colour = mean_obvs_het, size = n_individuals),
             data = LAB_cluster)+
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  scale_size(range = c(2, 6)) + 
  theme_bw() + 
  theme(legend.position = "bottom") +
  labs(title = "Mean heterozygosity per location. LAB only", 
       subtitle = "locations with less than 50% high admixture individuals", 
       color = "Mean heterozygosity", 
       size = "number of individuals")


ggsave('../data/external/heterozygosity_map_points_LAB.png', LAB_het_map)

print("STL only")
STL_cluster = het_and_meta_non_admix[het_and_meta_non_admix$CID == "STL",]
STL_cluster = STL_cluster[STL_cluster$lon < -55.,]

# #plot a sub region
lat_min = min(STL_cluster$lat, na.rm = TRUE)
lat_max = max(STL_cluster$lat, na.rm = TRUE)
long_min = min(STL_cluster$lon, na.rm = TRUE)
long_max = max(STL_cluster$lon, na.rm = TRUE)

STL_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  geom_point(aes(x = lon, y = lat, colour = mean_obvs_het, size = n_individuals), 
             data = STL_cluster)+
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  scale_size(range = c(2, 6)) + 
  theme_bw() + 
  theme(legend.position = "bottom") + 
  labs(title = "Mean heterozygosity per location. STL only", 
       subtitle = "locations with less than 50% high admixture individuals", 
       color = "Mean heterozygosity", 
       size = "number of individuals")

ggsave('../data/external/heterozygosity_map_points_STL.png', STL_het_map)


print("NFL only")
NFL_cluster = het_and_meta_non_admix[het_and_meta_non_admix$CID == "NFL",]
NFL_cluster = NFL_cluster[NFL_cluster$lon > -58.,]

# #plot a sub region
lat_min = min(NFL_cluster$lat, na.rm = TRUE)
lat_max = max(NFL_cluster$lat, na.rm = TRUE)
long_min = min(NFL_cluster$lon, na.rm = TRUE)
long_max = max(NFL_cluster$lon, na.rm = TRUE)

NFL_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  geom_point(aes(x = lon, y = lat, colour = mean_obvs_het, size = n_individuals), data = NFL_cluster)+
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  scale_size(range = c(2, 6)) + 
  theme_bw() + 
  theme(legend.position = "bottom") +
  labs(title = "Mean heterozygosity per location. NFL only", 
       subtitle = "locations with less than 50% high admixture individuals", 
       color = "Mean heterozygosity", 
       size = "number of individuals")

ggsave('../data/external/heterozygosity_map_points_NFL.png', NFL_het_map)







print("plot the PC values on a map as a heatmap")

world = ne_countries(scale = "medium", returnclass = "sf")
class(world)
# #plot a sub region
lat_min = min(het_and_meta_non_admix$lat, na.rm = TRUE)
lat_max = max(het_and_meta_non_admix$lat, na.rm = TRUE)
long_min = min(het_and_meta_non_admix$lon, na.rm = TRUE)
long_max = max(het_and_meta_non_admix$lon, na.rm = TRUE)
# 
theme_set(theme_bw())


#If you want a filled contour you will have to manually create a matrix covering the area of interest, 
#get the mean population in each bin, convert that into a data frame, then use geom_contour_filled:

z <- tapply(het_and_meta_non_admix$mean_obvs_het, list(cut(het_and_meta_non_admix$lat, 200), 
                               cut(het_and_meta_non_admix$lon, 200)), mean, na.rm = TRUE)

df <- expand.grid(x = seq(min(het_and_meta_non_admix$lat), max(het_and_meta_non_admix$lat), length = 200),
                  y = seq(min(het_and_meta_non_admix$lon), max(het_and_meta_non_admix$lon), length = 200))


df$z <- c(tapply(het_and_meta_non_admix$mean_obvs_het, list(cut(het_and_meta_non_admix$lat, 200), 
                                    cut(het_and_meta_non_admix$lon, 200)), mean, na.rm = TRUE))

df$z[is.na(df$z)] <- 0

ggplot(df, aes(x, y)) + 
  geom_contour_filled(aes(z = z), alpha = 0.5) +
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0)


print("all locations with low admixture")
all_het_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(xlim = c(long_min - 1, long_max + 1), 
           ylim = c(lat_min - 1, lat_max + 1), expand = FALSE) +
  
  
  all_het_map = ggplot(aes(x = lon, y = lat, fill = mean_obvs_het), 
                       data = het_and_meta_non_admix)+  
  geom_tile( alpha = 0.5)+
  scale_colour_continuous_sequential("Viridis", na.value = "transparent", end=0.0, begin = 1.0) + 
  theme_bw() + 
  theme(legend.position = "bottom")+
  labs(title = "Mean heterozygosity per location, all locations", 
       subtitle = "locations with less than 50% high admixture individuals", 
       color = "Mean heterozygosity")


ggsave('../data/external/heterozygosity_map_points_all.png', all_het_map)






