
####
# set the working directory
####

data_path = "C:/Users/camnu/bin/salmon-genomic-vulnerability/data/"
setwd(data_path)


####
# load necessary libraries
####

library(tidyverse)
library(data.table)
library(pcadapt)


####
# Read in the metadata and full PCA file
####
NA_PC_Meta = read_tsv("full_wild_PCA_and_meta.tsv")


####
# look at the plot to find the sub-groups
####

location_pca_of_filtered_NA_wild = ggplot() + 
  geom_point(data = NA_PC_Meta, aes(x =PC1, y = PC2, colour = location_id))  +
  labs(title = "PCA of filtered genetic variation - North American wild individuals",
       subtitle = "coloured by river (149 unique),  5455 individuals, 65576 SNPs")+
  xlab("PC1 (3.39% of variance)") +
  ylab("PC2 (1.46% variance explained)")+
  theme(legend.position = "none")


Prov_pca_of_filtered_NA_wild = ggplot() + 
  geom_point(data = NA_PC_Meta, aes(x =PC1, y = PC2, colour = Province))  +
  labs(title = "PCA of filtered genetic variation - North American wild individuals",
       subtitle = "coloured by Province/State,  5455 individuals, 65576 SNPs")+
  xlab("PC1 (3.39% of variance)") +
  ylab("PC2 (1.46% variance explained)")

ggsave('external/wild_NA_only_pca_by_Province.png', Prov_pca_of_filtered_NA_wild)


## what is in the top cluster of NL?
## Are these from a specific geographic region?

## Top cluster is 433 individuals, 22 from NL rest labrador

# the other 3535 NL individuals all go to the southern cluster.

# again the PCA essentially draws the map!



######
# subset the different groups

Labrador_samples = NA_PC_Meta[NA_PC_Meta$Province == "NL-Labrador",]
lab_only_filter = Labrador_samples %>% select(location_id,  fish_id)
outfile = "raw/only_Labrador_individuals.tsv"
write.table(lab_only_filter, outfile, col.names = F, row.names = F, quote = F, sep = "\t")

NL_samples = NA_PC_Meta[NA_PC_Meta$Province == "NL",]
NL_only_filter = NL_samples %>% select(location_id,  fish_id)
outfile = "raw/only_NL_individuals.tsv"
NL_only_filter = NL_only_filter[!is.na(NL_only_filter$location_id), ]
write.table(NL_only_filter, outfile, col.names = F, row.names = F, quote = F, sep = "\t")

other_samples = NA_PC_Meta[!NA_PC_Meta$Province %in% c("NL","NL-Labrador"),]
nonNL_only_filter = other_samples %>% select(location_id,  fish_id)
outfile = "raw/only_non_NL_individuals.tsv"
write.table(nonNL_only_filter, outfile, col.names = F, row.names = F, quote = F, sep = "\t")


#######
# subset the files
#######


#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --keep only_Labrador_individuals.tsv --make-bed --maf 0.01 --out labrador_salmon

#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --keep only_NL_individuals.tsv --make-bed --maf 0.01 --out nl_salmon

#plink --bfile wildNA_220k_filtered --chr-set 30 no-xy --keep only_non_NL_individuals.tsv --make-bed --maf 0.01 --out non_nl_salmon


#######
# run the PCA on the filtered SNP file
#######

print("labrador samples")
input_lab_pca = read.pcadapt("raw/labrador_salmon.bed", type = "bed")
labrador_PCA = pcadapt(input_lab_pca, K = 2, min.maf = 0.01)
(labrador_PCA$singular.values)^2*100 # 
Lab_FAM <- fread("raw/labrador_salmon.fam") %>% select(V1, V2)
colnames(Lab_FAM) <- c("SiteCode", "fish_id")
Lab_PCA_Scores = data.frame(labrador_PCA$scores)
colnames(Lab_PCA_Scores) = c("sub_PC1", "sub_PC2")
lab_PC_Meta = bind_cols(Lab_FAM, Lab_PCA_Scores) 
lab_sub_PCs = left_join(Labrador_samples, lab_PC_Meta)
lab_sub_PCs = drop_na(lab_sub_PCs)
write_tsv(lab_sub_PCs, "raw/Labrador_sub_group_pca.tsv")

print("NL samples")
input_other_pca = read.pcadapt("raw/nl_salmon.bed", type = "bed")
NL_PCA = pcadapt(input_NL_pca, K = 2, min.maf = 0.01)
(NL_PCA$singular.values)^2*100 # 
NL_FAM <- fread("raw/nl_salmon.fam") %>% select(V1, V2)
colnames(NL_FAM) <- c("SiteCode", "fish_id")
NL_PCA_Scores = data.frame(NL_PCA$scores)
colnames(NL_PCA_Scores) = c("sub_PC1", "sub_PC2")
NL_PC_Meta = bind_cols(NL_FAM, NL_PCA_Scores) 
NL_sub_PCs = left_join(NL_samples, NL_PC_Meta)
NL_sub_PCs = drop_na(NL_sub_PCs)
write_tsv(NL_sub_PCs, "raw/NL_sub_group_pca.tsv")

print("other samples")
input_nonNL_pca = read.pcadapt("raw/non_nl_salmon.bed", type = "bed")

nonNL_PCA = pcadapt(input_nonNL_pca, K = 2, min.maf = 0.01)
(nonNL_PCA$singular.values)^2*100 # 
nonNL_FAM <- fread("raw/non_nl_salmon.fam") %>% select(V1, V2)
colnames(nonNL_FAM) <- c("SiteCode", "fish_id")
nonNL_PCA_Scores = data.frame(nonNL_PCA$scores)
colnames(nonNL_PCA_Scores) = c("sub_PC1", "sub_PC2")
nonNL_PC_Meta = bind_cols(nonNL_FAM, nonNL_PCA_Scores) 
nonNL_sub_PCs = left_join(other_samples, nonNL_PC_Meta)
nonNL_sub_PCs = drop_na(nonNL_sub_PCs)
write_tsv(nonNL_sub_PCs, "raw/nonNL_sub_group_pca.tsv")




#####
# plot the PCs
##### 


lab_sub_PCs = read_tsv("raw/Labrador_sub_group_pca.tsv")

length(table(lab_sub_PCs$location_id))

labrador_river_PCA_plot = ggplot() + 
  geom_point(data = lab_sub_PCs, aes(x = PC1, y = PC2, colour = location_id))  +
  labs(title = "PCA of Labrador sample site genetic variation",
       subtitle = "coloured by river (20 unique),  409 individuals")+
  xlab("PC1 (2.87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Labrador_initial_pca_by_location.png', labrador_river_PCA_plot)


labrador_lon_PCA_plot = ggplot() + 
  geom_point(data = lab_sub_PCs, aes(x = PC1, y = PC2, colour = lon))  +
  labs(title = "PCA of Labrador sample site genetic variation",
       subtitle = "coloured by longitude,  409 individuals")+
  xlab("PC1 (2.87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Labrador_initial_pca_by_longitude.png', labrador_lon_PCA_plot)

print("Longitude gradient in the Labrador samples - seen in the initital PCs")

labrador_river_PCA_plot = ggplot() + 
  geom_point(data = lab_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = location_id))  +
  labs(title = "PCA of Labrador sample site genetic variation",
       subtitle = "coloured by river (20 unique),  409 individuals")+
  xlab("PC1 (2.87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Labrador_initial_pca_by_location.png', labrador_river_PCA_plot)


labrador_lon_PCA_plot = ggplot() + 
  geom_point(data = lab_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = lon))  +
  labs(title = "PCA of Labrador sample site genetic variation",
       subtitle = "coloured by longitude,  409 individuals")+
  xlab("PC1 (2.87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Labrador_initial_pca_by_longitude.png', labrador_lon_PCA_plot)



NL_sub_PCs = read_tsv("raw/NL_sub_group_pca.tsv")

length(unique(NL_sub_PCs$location_id))

NL_PCA_plot_location = ggplot() + 
  geom_point(data = NL_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = location_id))  +
  labs(title = "PCA of Newfoundland sample site genetic variation",
       subtitle = "coloured by river (83 unique),  3555 individuals")+
  xlab("PC1 (1.64% of variance)") +
  ylab("PC2 (1.02% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Newfoundland_pca_by_location.png', NL_PCA_plot_location)


NL_PCA_plot_lon = ggplot() + 
  geom_point(data = NL_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = lon))  +
  labs(title = "PCA of Labrador sample site genetic variation",
       subtitle = "coloured by longitude,  3555 individuals")+
  xlab("PC1 (2..87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Newfoundland_pca_by_longitude.png', NL_PCA_plot_lon)



nonNL_sub_PCs = read_tsv("raw/nonNL_sub_group_pca.tsv")

#2.139513 1.937071

length(unique(nonNL_sub_PCs$location_id))

nonNL_PCA_plot_location = ggplot() + 
  geom_point(data = nonNL_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = location_id))  +
  labs(title = "PCA of All maritimes (not NL and Labrador), sample site genetic variation",
       subtitle = "coloured by river (49 unique),  1487 individuals")+
  xlab("PC1 (2.14% of variance)") +
  ylab("PC2 (1.94% variance explained)")+
  theme(legend.position = "none")
ggsave('external/nonNL_pca_by_location.png', nonNL_PCA_plot_location)


NL_PCA_plot_lon = ggplot() + 
  geom_point(data = nonNL_sub_PCs, aes(x = sub_PC1, y = sub_PC2, colour = lon))  +
  labs(title = "PCA of All maritimes (not NL and Labrador), sample site genetic variation",
       subtitle = "coloured by river (49 unique),  1487 individuals")+
  xlab("PC1 (2..87% of variance)") +
  ylab("PC2 (2.07% variance explained)")+
  theme(legend.position = "none")
ggsave('external/Newfoundland_pca_by_longitude.png', NL_PCA_plot_lon)



nonNL_orgPCA_plot_location = ggplot() + 
  geom_point(data = nonNL_sub_PCs, aes(x = PC1, y = PC2, colour = location_id))  +
  labs(title = "PCA of All maritimes (not NL and Labrador), sample site genetic variation",
       subtitle = "coloured by river (49 unique),  1487 individuals")+
  xlab("PC1 (2.14% of variance)") +
  ylab("PC2 (1.94% variance explained)") +
  theme(legend.position = "none")
ggsave('external/nonNL_original_pcs_by_location.png', nonNL_orgPCA_plot_location)

nonNL_orgPCA_plot_lon = ggplot() + 
  geom_point(data = nonNL_sub_PCs, aes(x = PC1, y = PC2, colour = lat))  +
  labs(title = "PCA of All maritimes (not NL and Labrador), sample site genetic variation",
       subtitle = "coloured by latitude,  1487 individuals")+
  xlab("PC1 (2.14% of variance)") +
  ylab("PC2 (1.94% variance explained)")+
  theme(legend.position = "none")
ggsave('external/nonNL_original_pcs_by_latitude.png', nonNL_orgPCA_plot_location)
