###################################################
#Set the working directory
setwd("C:/Users/camnu/bin/salmon-genomic-vulnerability/data/")


###################################################
# load the necessary libraries

library(tidyverse)



###################################################
# load necessary functions


remove_zero_variance_columns <- function(dat) {
  out = lapply(dat, function(x) length(unique(x)))
  z_var = names(which(!out > 1))
  return(dat[!names(dat) %in% z_var])
}

#' Take a data frame with ONLY a set of predictor variables
#' Create a new data frame with only a set of variables for which the 
#' correlation coefficients do not exceede the specified threshold (default is 0.7).
get_uncorrelated_predictors = function(env_vals, threshold = 0.7, drop_zero_variance = TRUE){
  # make a correlation matrix, 
  # set the upper triangle to be zero and then remove any rows that have values over 0.99.
  if(drop_zero_variance == TRUE){
    env_vals = remove_zero_variance_columns(env_vals)
  }
  tmp = cor(env_vals)
  tmp[upper.tri(tmp)] = 0
  diag(tmp) = 0
  env_uncorr = env_vals[, !apply(tmp, 2, function(x) any(abs(x) > threshold, na.rm = TRUE))]
  return(env_uncorr)
}




###################################################
#
print("Read the genetics information in")


geno_data = read_table('raw/Salmo_220K_Merged2022_COMPLETE_ENVmatchyear.raw')      
print("temp - drop the rows for the anamolous location")
geno_data = geno_data[geno_data$FID != "COR",]
names(geno_data)[1:10]

gen_cols = names(geno_data)[7:length(geno_data)]




print("read the environmental information in")

meta_data = read_tsv('raw/Salmo_220K_Merged2022_ENVmatchyear_Metadata.txt')      
print("temp - drop the rows for the anamolous location")
meta_data = meta_data[meta_data$FID != "COR",]

meta_data = na.omit(meta_data)
meta_data$FID = meta_data$SiteCode
meta_data$IID = meta_data$ID

leading_cols = c("FID", "IID")
pred_cols = c("Minimum.Air.Temperature", "Air.Temperature",         "Maximum.Air.Temperature", "Total.Precipitation" ,    "Dew.Point.Temperature",
              "Relative.Humidity",       "Wind.Direction",          "Solar.Radiation",         "Atmospheric.Pressure" ,   "Snow.Precipitation",
              "Snow.Depth.Accumulation", "Snow.Water.Equivalent",   "Wind.Speed.at.2.meters")

keep_cols = c(leading_cols, pred_cols)

uncor_preds = get_uncorrelated_predictors(meta_data[pred_cols])
uncor_preds_names = names(uncor_preds)

# 6 uncorrelated predictors
# Total.Precipitation Relative.Humidity Wind.Direction Solar.Radiation Snow.Water.Equivalent Wind.Speed.at.2.meters
relevant_meta_cols = as_tibble(cbind(meta_data[leading_cols], uncor_preds))


print("pair the ENV and genetics data")

geno_data = geno_data[geno_data$IID %in% relevant_meta_cols$IID, ]
relevant_meta_cols = relevant_meta_cols[relevant_meta_cols$IID %in% geno_data$IID, ]

geno_data=geno_data[order(geno_data$IID),]
relevant_meta_cols=relevant_meta_cols[order(relevant_meta_cols$IID),]

geno_data$IID[1:10] == relevant_meta_cols$IID[1:10]


gen_env_input=cbind(relevant_meta_cols[uncor_preds_names], geno_data)
gen_env_input = as_tibble(gen_env_input)


#tried this but it was crazy slow, may need a data table solution
#gen_env_input = inner_join(relevant_meta_cols, geno_data)

write_tsv(gen_env_input, "interim/RDA_input_uncor_env_and_Genetics.tsv")


print("make a random subset of the complete data set")
length(gen_cols)

geno_subset_cols = sample(gen_cols, 5000)


subset_5k_snp_index = c(leading_cols, uncor_preds_names, geno_subset_cols)


random5k_subset = gen_env_input[subset_5k_snp_index]
write_tsv(random5k_subset, "interim/RDA_input_uncor_env_and_5k_random_subset_Genetics.tsv")

